<!DOCTYPE html>
<!--
═══════════════════════════════════════════════════════════════════════════════
  VLEP Mission v3.6
  © 2025 Quentin THOMAS - Tous droits réservés
  
  CONFIDENTIEL - USAGE STRICTEMENT INTERNE
  
  Ce logiciel et son code source sont la propriété exclusive de Quentin THOMAS.
  Toute reproduction, distribution, modification ou utilisation non autorisée
  est strictement interdite sans l'accord écrit préalable de l'auteur.
  
  Auteur : Quentin THOMAS
  Création : 2025
═══════════════════════════════════════════════════════════════════════════════
-->
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VLEP Mission">
  <meta name="theme-color" content="#0066b3">
  <meta name="author" content="Quentin THOMAS">
  <meta name="copyright" content="© 2025 Quentin THOMAS - Tous droits réservés">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>VLEP Mission v3.6 - © Quentin THOMAS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* 
     * VLEP Mission v3.6
     * © 2025 Quentin THOMAS - Tous droits réservés
     * Propriété exclusive - Reproduction interdite
     */
    /* === VLEP Mission v3.6 - Design Socotec Blue Refined === */
    :root {
      --primary: #0066b3;
      --primary-dark: #004d87;
      --primary-light: #1a8fd4;
      --primary-pale: #e6f2fa;
      --accent: #00a878;
      --accent-light: #00c896;
      --warning: #f59e0b;
      --danger: #e63946;
      --purple: #7c3aed;
      --bg-main: #f0f7fc;
      --bg-card: #ffffff;
      --text-dark: #1a1a2e;
      --text-muted: #64748b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 70px, var(--bg-main) 70px); min-height: 100vh; padding: 0 0 60px 0; }
    .container { max-width: 520px; margin: 0 auto; padding: 8px 12px; }
    .card { background: var(--bg-card); border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; box-shadow: 0 1px 6px rgba(0,102,179,0.07); }
    h1 { font-size: 18px; color: var(--primary); margin-bottom: 2px; display: flex; align-items: center; gap: 8px; }
    h1 svg { width: 20px; height: 20px; flex-shrink: 0; }
    h2 { font-size: 15px; color: var(--primary); margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    h2 svg { width: 18px; height: 18px; flex-shrink: 0; }
    .subtitle { color: var(--text-muted); font-size: 12px; }
    .icon { width: 20px; height: 20px; flex-shrink: 0; }
    .icon-sm { width: 16px; height: 16px; }
    .icon-lg { width: 24px; height: 24px; }
    .btn { padding: 9px 14px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn svg { width: 15px; height: 15px; }
    .btn:active { transform: scale(0.97); }
    .btn:hover { filter: brightness(1.06); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--accent); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-gray { background: #f1f5f9; color: var(--text-dark); border: 1px solid #e2e8f0; }
    .btn-blue { background: var(--primary-pale); color: var(--primary); }
    .btn-orange { background: var(--warning); color: white; }
    .btn-small { padding: 6px 10px; font-size: 12px; width: auto; }
    .btn-icon { width: 28px; height: 28px; padding: 0; border-radius: 7px; }
    .btn-icon svg { width: 14px; height: 14px; }
    .row { display: flex; gap: 6px; flex-wrap: wrap; }
    .row .btn { flex: 1; min-width: 80px; }
    .nav-menu { display: flex; flex-direction: column; gap: 6px; margin: 8px 0; }
    .nav-item { display: flex; align-items: center; gap: 10px; background: var(--bg-card); padding: 10px 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 4px rgba(0,102,179,0.06); border: 1px solid #eaf2f8; }
    .nav-item:hover { border-color: var(--primary-light); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,102,179,0.1); }
    .nav-item:active { transform: scale(0.98) translateY(0); }
    .nav-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary-dark), var(--primary)); border-radius: 9px; color: white; flex-shrink: 0; }
    .nav-icon svg { width: 18px; height: 18px; }
    .nav-icon.green { background: linear-gradient(135deg, var(--accent), var(--accent-light)); }
    .nav-icon.orange { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
    .nav-icon.purple { background: linear-gradient(135deg, #7c3aed, #a78bfa); }
    .nav-label { flex: 1; font-weight: 600; color: var(--text-dark); font-size: 14px; }
    .nav-count { font-size: 11px; color: white; background: var(--primary); padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .back-btn { background: none; border: none; color: white; font-size: 13px; font-weight: 600; padding: 5px 0; margin-bottom: 2px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .back-btn svg { width: 16px; height: 16px; }
    .section-title { font-size: 11px; font-weight: 700; color: var(--primary); margin: 12px 0 6px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
    .section-title::before { content: ''; width: 3px; height: 13px; background: var(--accent); border-radius: 2px; }
    .field { margin-bottom: 10px; }
    .label { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
    .label svg { width: 14px; height: 14px; }
    .input { width: 100%; padding: 9px 10px; border: 1.5px solid #dce8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; -webkit-appearance: none; background: #f8fafc; }
    .input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(0,102,179,0.1); }
    .info-box { background: linear-gradient(135deg, #eef5fc, #ddeaf5); border-left: 3px solid var(--primary); border-radius: 8px; padding: 10px 12px; font-size: 12px; color: var(--primary-dark); }
    .info-box p { margin-bottom: 3px; line-height: 1.5; }
    .info-box p:last-child { margin-bottom: 0; }
    .info-box-warning { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left-color: var(--warning); color: #92400e; }
    .info-box-success { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-left-color: var(--accent); color: #065f46; }
    .empty-state { text-align: center; padding: 28px 16px; color: var(--text-muted); }
    .empty-state-icon { margin-bottom: 8px; opacity: 0.4; }
    .empty-state-icon svg { width: 40px; height: 40px; stroke: var(--primary); }
    .mission-card { background: var(--bg-card); border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); transition: all 0.2s; }
    .mission-card:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.07); }
    .mission-card-prepa { border-left: 4px solid var(--warning); }
    .mission-card-validee { border-left: 4px solid var(--accent); }
    .mission-card-encours { border-left: 4px solid var(--primary); }
    .mission-card-terminee { border-left: 4px solid var(--purple); }
    .mission-title { font-size: 14px; font-weight: 700; color: var(--text-dark); margin-bottom: 3px; display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    .mission-info { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .mission-actions { display: flex; gap: 5px; flex-wrap: wrap; }
    .status-badge { font-size: 10px; font-weight: 600; padding: 3px 8px; border-radius: 12px; display: inline-flex; align-items: center; gap: 4px; }
    .status-badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; }
    .status-prepa { background: #fef3c7; color: #b45309; }
    .status-prepa::before { background: var(--warning); }
    .status-validee { background: #d1fae5; color: #047857; }
    .status-validee::before { background: var(--accent); }
    .status-encours { background: var(--primary-pale); color: var(--primary-dark); }
    .status-encours::before { background: var(--primary); }
    .status-terminee { background: #ede9fe; color: #6d28d9; }
    .status-terminee::before { background: var(--purple); }
    .geh-item { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 8px 10px; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .geh-num { width: 26px; height: 26px; background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; }
    .geh-input { flex: 1; padding: 8px 10px; border: 1.5px solid #dce8f0; border-radius: 7px; font-size: 13px; -webkit-appearance: none; background: #f8fafc; min-width: 0; }
    .geh-input:focus { outline: none; border-color: var(--primary); background: white; }
    .agent-item { display: flex; align-items: center; gap: 8px; background: var(--bg-card); padding: 8px 10px; border-radius: 8px; margin-bottom: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .agent-color { width: 4px; height: 28px; border-radius: 2px; flex-shrink: 0; }
    .agent-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--text-dark); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .agent-badges { display: flex; gap: 4px; }
    .agent-badge { padding: 4px 9px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1.5px solid #dce8f0; background: white; color: #94a3b8; transition: all 0.15s; }
    .agent-badge.active { border-color: transparent; }
    .agent-badge-8h.active { background: var(--primary); color: white; }
    .agent-badge-ct.active { background: var(--purple); color: white; }
    .agent-badge.disabled { opacity: 0.3; cursor: not-allowed; }
    .agent-delete { width: 26px; height: 26px; border: none; background: #fee2e2; color: var(--danger); border-radius: 7px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .agent-delete svg { width: 14px; height: 14px; }
    .search-box { position: relative; margin-bottom: 8px; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
    .search-icon svg { width: 17px; height: 17px; }
    .search-input { width: 100%; padding: 10px 10px 10px 34px; border: 1.5px solid #dce8f0; border-radius: 9px; font-size: 14px; background: white; transition: all 0.2s; }
    .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,102,179,0.1); }
    .search-results { background: white; border-radius: 9px; margin-top: 5px; overflow: hidden; box-shadow: 0 3px 14px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
    .search-result-item { padding: 9px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: var(--text-dark); transition: background 0.15s; }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f0f7fc; }
    .search-result-item:active { background: var(--primary-pale); }
    .affect-card { background: var(--bg-card); border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .affect-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1.5px solid #f1f5f9; }
    .affect-agent { flex: 1; font-weight: 700; color: var(--text-dark); font-size: 13px; }
    .affect-reg-toggle { font-size: 10px; padding: 4px 8px; border-radius: 12px; cursor: pointer; background: #d1fae5; color: #047857; border: none; font-weight: 600; }
    .affect-reg-toggle.nonreg { background: #fef3c7; color: #b45309; }
    .affect-geh-row { display: flex; align-items: center; gap: 6px; padding: 7px 8px; background: #f8fafc; border-radius: 7px; margin-bottom: 4px; }
    .affect-geh-name { flex: 1; font-size: 12px; font-weight: 600; color: var(--text-dark); }
    .affect-geh-badges { display: flex; gap: 4px; }
    .affect-mini-badge { padding: 4px 10px; border-radius: 5px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1.5px solid #dce8f0; background: white; color: #94a3b8; transition: all 0.15s; }
    .affect-mini-badge.active-8h { background: var(--primary); color: white; border-color: var(--primary); }
    .affect-mini-badge.active-ct { background: var(--purple); color: white; border-color: var(--purple); }
    .affect-mini-badge.disabled { opacity: 0.3; cursor: not-allowed; }
    .affect-reg-toggle-mini { font-size: 10px; padding: 4px 7px; border-radius: 5px; cursor: pointer; background: #d1fae5; color: #047857; border: none; font-weight: 700; margin-left: 2px; transition: all 0.15s; }
    .affect-reg-toggle-mini.nonreg { background: #fef3c7; color: #b45309; }
    .affect-reg-toggle-mini:hover { filter: brightness(0.95); }
    .accordion { margin-bottom: 6px; }
    .accordion-header { display: flex; align-items: center; gap: 8px; padding: 9px 10px; background: var(--bg-card); border-radius: 9px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.04); transition: all 0.2s; }
    .accordion-header:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.07); }
    .accordion-header.open { border-radius: 9px 9px 0 0; background: linear-gradient(135deg, #f0f7fc, #e4eff7); }
    .accordion-icon { transition: transform 0.2s; color: var(--primary); }
    .accordion-icon svg { width: 16px; height: 16px; }
    .accordion-header.open .accordion-icon { transform: rotate(90deg); }
    .accordion-title { flex: 1; font-weight: 700; color: var(--text-dark); font-size: 13px; }
    .accordion-count { font-size: 11px; color: white; background: var(--accent); padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .accordion-body { display: none; background: white; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 9px 9px; padding: 8px; }
    .accordion-body.open { display: block; }
    .prel-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .prel-item:hover { transform: translateX(4px); }
    .prel-item:active { transform: scale(0.98); }
    .prel-item.selected { border-color: var(--warning); background: #fffbeb !important; }
    .prel-status { width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .prel-status svg { width: 13px; height: 13px; }
    .prel-status.pending { background: #f1f5f9; color: #94a3b8; }
    .prel-status.done { background: var(--accent); color: white; }
    .prel-content { flex: 1; }
    .prel-title { font-size: 13px; font-weight: 600; }
    .prel-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .prel-arrow { color: #cbd5e1; }
    .prel-arrow svg { width: 16px; height: 16px; }
    .prel-reg-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; background: #d1fae5; color: #047857; }
    .prel-nonreg-badge { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; background: #fef3c7; color: #b45309; }
    .prel-checkbox { width: 22px; height: 22px; border: 1.5px solid #cbd5e1; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: white; flex-shrink: 0; }
    .prel-checkbox svg { width: 13px; height: 13px; opacity: 0; }
    .prel-checkbox.checked { background: var(--warning); border-color: var(--warning); }
    .prel-checkbox.checked svg { opacity: 1; color: white; }
    .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin-bottom: 4px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-light)); border-radius: 4px; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: var(--text-muted); }
    .plage-row { display: flex; align-items: center; gap: 4px; margin-bottom: 5px; }
    .plage-num { width: 22px; height: 22px; background: var(--primary); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
    .plage-input { flex: 1; padding: 7px 6px; border: 1.5px solid #dce8f0; border-radius: 7px; font-size: 13px; -webkit-appearance: none; min-width: 0; background: #f8fafc; text-align: center; }
    .plage-input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 2px rgba(0,102,179,0.1); }
    .plage-sep { color: var(--text-muted); font-weight: 600; }
    .plage-delete { width: 22px; height: 22px; background: #fee2e2; color: var(--danger); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .plage-delete svg { width: 13px; height: 13px; }
    .duration-box { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 8px; padding: 8px; margin: 8px 0; font-size: 13px; font-weight: 600; color: #047857; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .duration-box svg { width: 16px; height: 16px; }
    .condition-card { background: var(--bg-card); border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .condition-date { font-weight: 700; color: var(--text-dark); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
    .condition-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; }
    .condition-label { font-size: 12px; font-weight: 600; color: var(--text-dark); display: flex; align-items: center; gap: 5px; }
    .condition-label svg { width: 15px; height: 15px; color: var(--primary); }
    .condition-inputs { display: flex; gap: 6px; flex-wrap: nowrap; }
    .condition-input { flex: 1; padding: 8px 4px; border: 1.5px solid #dce8f0; border-radius: 7px; font-size: 13px; text-align: center; -webkit-appearance: none; min-width: 0; background: #f8fafc; }
    .condition-input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 2px rgba(0,102,179,0.1); }
    .condition-input-i { background: #fef3c7; border-color: #fcd34d; }
    .condition-input-f { background: #dbeafe; border-color: #93c5fd; }
    .condition-input-label { font-size: 10px; color: var(--text-muted); text-align: center; margin-bottom: 3px; font-weight: 600; }
    .tabs { display: flex; gap: 3px; margin-bottom: 10px; background: #f1f5f9; padding: 3px; border-radius: 10px; }
    .tab { flex: 1; padding: 7px 4px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; background: transparent; color: var(--text-muted); transition: all 0.2s; }
    .tab.active { background: white; color: var(--primary); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .multi-agent-item { display: flex; flex-direction: column; gap: 6px; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 6px; border: 1px solid #e2e8f0; }
    .multi-agent-header { display: flex; align-items: center; gap: 8px; }
    .multi-agent-color { width: 5px; height: 32px; border-radius: 3px; }
    .multi-agent-name { flex: 1; font-size: 13px; font-weight: 600; color: var(--text-dark); }
    .multi-agent-fields { display: flex; flex-direction: column; gap: 6px; margin-left: 11px; }
    .multi-agent-row { display: flex; align-items: center; gap: 6px; }
    .multi-agent-row label { font-size: 11px; color: var(--text-muted); width: 64px; flex-shrink: 0; font-weight: 500; }
    .multi-agent-row input { flex: 1; padding: 6px 8px; border: 1.5px solid #dce8f0; border-radius: 7px; font-size: 13px; -webkit-appearance: none; background: white; min-width: 0; }
    .multi-agent-row input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,102,179,0.1); }
    .debit-variation { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 5px; background: #f1f5f9; color: var(--text-muted); margin-left: 4px; }
    .debit-variation.warning { background: #fed7aa; color: #c2410c; }
    .debit-input.warning { border-color: #f97316 !important; background: #fff7ed; }
    .agent-card { background: var(--bg-card); border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .agent-card-name { font-size: 15px; font-weight: 700; color: var(--text-dark); margin-bottom: 2px; }
    .agent-card-cas { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
    .agent-card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .agent-card-field { background: #f8fafc; padding: 7px 8px; border-radius: 7px; }
    .agent-card-field.full { grid-column: span 2; }
    .agent-card-field-label { font-size: 9px; font-weight: 700; color: var(--text-muted); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
    .agent-card-field-value { font-size: 12px; color: var(--text-dark); font-weight: 500; }
    .agent-card-field-value.highlight { color: var(--accent); font-weight: 700; }
    .agent-card-field-value.cmr { color: var(--danger); font-weight: 700; }
    .version-info { text-align: center; font-size: 10px; color: var(--text-muted); padding: 14px 0; }
    .sticky-header { position: sticky; top: -8px; z-index: 50; background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%); margin: -8px -12px 8px; padding: 8px 12px; border-radius: 0 0 12px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .dictation-btn { width: 32px; height: 32px; padding: 0; border: none; border-radius: 7px; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
    .dictation-btn svg { width: 16px; height: 16px; }
    .dictation-btn.recording { background: var(--danger); animation: pulse-record 1s infinite; }
    @keyframes pulse-record { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
    .blanc-warning { background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 3px solid var(--warning); border-radius: 8px; padding: 8px 10px; font-size: 11px; color: #92400e; margin-top: 6px; display: flex; align-items: center; gap: 6px; }
    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.6); display: none; align-items: flex-end; justify-content: center; z-index: 1000; padding: 16px; backdrop-filter: blur(4px); }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 16px 16px 0 0; padding: 16px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1.5px solid #f1f5f9; }
    .modal-header h2 { font-size: 16px; color: var(--text-dark); margin-bottom: 0; }
    .close-btn { width: 28px; height: 28px; border: none; background: #f1f5f9; border-radius: 7px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.15s; }
    .close-btn:hover { background: #e2e8f0; color: var(--text-dark); }
    .close-btn svg { width: 16px; height: 16px; }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mb-12 { margin-bottom: 12px; }
    .mt-16 { margin-top: 16px; }
    .copy-btn { padding: 3px 7px; font-size: 9px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 4px; font-weight: 600; display: inline-flex; align-items: center; gap: 3px; }
    .copy-btn:hover { filter: brightness(1.1); }
    .copy-btn svg { width: 10px; height: 10px; }
    .field-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .field-header .label { margin-bottom: 0; }
    /* SVG Icons inline helper */
    .svg-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; vertical-align: middle; }
    .svg-icon svg { width: 14px; height: 14px; }
  </style>
</head>
<body>
  <div class="container" id="app"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>

// ═══════════════════════════════════════════════════════════════════════════════
// VLEP Mission v3.6
// © 2025 Quentin THOMAS - Tous droits réservés
// CONFIDENTIEL - Propriété exclusive de Quentin THOMAS
// Toute reproduction ou utilisation non autorisée est interdite
// ═══════════════════════════════════════════════════════════════════════════════

// === SVG ICONS ===
var ICONS = {
  flask: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3h6v7l4 8a2 2 0 0 1-1.8 3H6.8a2 2 0 0 1-1.8-3l4-8V3z"/><path d="M9 3h6"/></svg>',
  clipboard: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
  building: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>',
  search: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>',
  database: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  folder: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
  beaker: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></svg>',
  link: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
  thermometer: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>',
  gauge: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>',
  droplet: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></svg>',
  user: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  tool: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  check: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
  x: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  trash: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
  edit: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
  copy: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
  play: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
  zap: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  merge: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22"/><path d="m20 22-5-5"/></svg>',
  plus: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  arrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>',
  arrowRight: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>',
  chevronRight: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
  clock: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  download: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
  upload: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
  list: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>',
  empty: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
  mic: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>',
  share: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>'
};

var AGENT_COLORS=['#00a878','#0f4c81','#e63946','#7c3aed','#f59e0b','#0891b2','#c026d3','#65a30d','#0284c7','#db2777','#4f46e5','#059669','#d97706','#7c2d12','#1d4ed8'];
var DEFAULT_GEH_COUNT=5;
var state={_author:'Quentin THOMAS',_copyright:'© 2025 Quentin THOMAS',view:'home',missions:[],agentsDB:[],currentMissionId:null,currentPrelId:null,activeSubIndex:0,showModal:null,searchText:'',expandedGeh:{},fusionMode:false,selectedForFusion:[],quickPrelType:'8h',quickPrelReg:true,quickAgentSearch:'',quickGehId:null,echantillonSort:'date',blancAgentSearch:'',blancAgents:[],quickMission:null,newPrelData:null,timers:{}};

function escapeHtml(t){if(!t)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function escapeJs(t){if(!t)return'';var s=String(t);s=s.split(String.fromCharCode(92)).join(String.fromCharCode(92,92));s=s.split(String.fromCharCode(39)).join(String.fromCharCode(92,39));s=s.replace(/"/g,'&quot;');return s;}
function generateId(){return Date.now()*1000+Math.floor(Math.random()*1000);}
function saveData(k,d){try{localStorage.setItem(k,JSON.stringify(d));}catch(e){}}
function loadData(){try{var m=localStorage.getItem('vlep_missions_v3');var d=localStorage.getItem('vlep_database');if(m)state.missions=JSON.parse(m);if(d)state.agentsDB=JSON.parse(d);repairMissions();}catch(e){}}
function repairMissions(){
  state.missions.forEach(function(m){
    if(m.prelevements){
      m.prelevements.forEach(function(p){
        if(!p.agents)p.agents=[];
      });
    }
    // Migration : déplacer isReg vers isReg8h et isRegCT
    if(m.affectations){
      for(var an in m.affectations){
        var af=m.affectations[an];
        if(af.gehs){
          for(var gid in af.gehs){
            var gaf=af.gehs[gid];
            // Migrer isReg global ou de GEH vers isReg8h et isRegCT
            var oldIsReg=(gaf.isReg!==undefined)?gaf.isReg:((af.isReg!==undefined)?af.isReg:true);
            if(gaf.isReg8h===undefined){
              gaf.isReg8h=oldIsReg;
            }
            if(gaf.isRegCT===undefined){
              gaf.isRegCT=oldIsReg;
            }
          }
        }
      }
    }
  });
}
function getCurrentMission(){for(var i=0;i<state.missions.length;i++){if(state.missions[i].id===state.currentMissionId)return state.missions[i];}return null;}
function getAgentColor(m,n){if(!m.agentColors)m.agentColors={};if(!m.agentColors[n]){var u=Object.values(m.agentColors);for(var i=0;i<AGENT_COLORS.length;i++){if(u.indexOf(AGENT_COLORS[i])===-1){m.agentColors[n]=AGENT_COLORS[i];break;}}if(!m.agentColors[n])m.agentColors[n]=AGENT_COLORS[Object.keys(m.agentColors).length%AGENT_COLORS.length];}return m.agentColors[n];}
function lightenColor(h,p){var n=parseInt(h.replace('#',''),16);var r=Math.min(255,Math.floor((n>>16)+(255-(n>>16))*p));var g=Math.min(255,Math.floor(((n>>8)&0xFF)+(255-((n>>8)&0xFF))*p));var b=Math.min(255,Math.floor((n&0xFF)+(255-(n&0xFF))*p));return'#'+(0x1000000+r*0x10000+g*0x100+b).toString(16).slice(1);}

// FIX #1: Support des deux noms de colonnes pour le code analytique
function getAgentFromDB(n){
  for(var i=0;i<state.agentsDB.length;i++){
    if(state.agentsDB[i]['Agent chimique']===n)return state.agentsDB[i];
  }
  return null;
}
function getCodeAnalytique(agent){
  if(!agent)return'';
  // Supporte les deux noms de colonnes
  return agent['code_analyse']||agent['Code analytique']||agent['Code analyse']||'';
}

function hasVLEP8h(n){var a=getAgentFromDB(n);return a&&a['VLEP 8h (mg/m3)']&&a['VLEP 8h (mg/m3)'].trim()!==''&&a['VLEP 8h (mg/m3)']!=='-';}
function hasVLEPCT(n){var a=getAgentFromDB(n);return a&&a['VLEP CT (mg/m3)']&&a['VLEP CT (mg/m3)'].trim()!==''&&a['VLEP CT (mg/m3)']!=='-';}

function createEmptyMission(){var g=[];for(var i=0;i<DEFAULT_GEH_COUNT;i++)g.push({id:generateId(),num:i+1,name:''});return{id:generateId(),status:'prepa',createdAt:new Date().toISOString(),clientSite:'',preleveur:'',debitmetre:'',gehs:g,agents:[],affectations:{},prelevements:[],conditionsAmbiantes:[],agentColors:{}};}

function render(){
  var h='';
  switch(state.view){
    case'home':h=renderHome();break;
    case'prepa-list':h=renderPrepaList();break;
    case'prepa-mission':h=renderPrepaMission();break;
    case'prepa-agents':h=renderPrepaAgents();break;
    case'prepa-affectations':h=renderPrepaAffectations();break;
    case'prepa-geh':h=renderPrepaGeh();break;
    case'terrain-list':h=renderTerrainList();break;
    case'terrain-mission':h=renderTerrainMission();break;
    case'terrain-prel':h=renderTerrainPrel();break;
    case'conditions':h=renderConditions();break;
    case'db-terrain':h=renderDbTerrain();break;
    case'db-full':h=renderDbFull();break;
    case'liste-echantillons':h=renderListeEchantillons();break;
    case'quick-entry':h=renderQuickEntry();break;
    default:h=renderHome();
  }
  document.getElementById('app').innerHTML=h;
  if(state.view==='db-terrain')setTimeout(updateDbResults,50);
  if(state.view==='quick-entry')setTimeout(function(){var i=document.getElementById('quick-agent-search');if(i)i.focus();},50);
}

function renderHome(){
  var mp=state.missions.filter(function(m){return m.status==='prepa';}).length;
  var mt=state.missions.filter(function(m){return m.status==='validee'||m.status==='encours';}).length;
  var h='<div class="card"><h1>'+ICONS.flask+' VLEP Mission</h1></div>';
  h+='<div class="nav-menu">';
  h+='<div class="nav-item" onclick="state.view=\'terrain-list\';render();"><div class="nav-icon green">'+ICONS.clipboard+'</div><div class="nav-label">Saisie terrain</div>';
  if(mt>0)h+='<div class="nav-count">'+mt+'</div>';
  h+='</div>';
  h+='<div class="nav-item" onclick="state.view=\'prepa-list\';render();"><div class="nav-icon">'+ICONS.building+'</div><div class="nav-label">Préparation mission</div>';
  if(mp>0)h+='<div class="nav-count">'+mp+'</div>';
  h+='</div>';
  h+='<div class="nav-item" onclick="triggerImportMission();"><div class="nav-icon" style="background:linear-gradient(135deg,#0891b2,#06b6d4);">'+ICONS.upload+'</div><div class="nav-label">Importer (fichier JSON)</div></div>';
  h+='<div class="nav-item" onclick="state.showModal=\'importQR\';render();"><div class="nav-icon" style="background:linear-gradient(135deg,var(--purple),#a78bfa);">'+ICONS.share+'</div><div class="nav-label">Importer (QR Code / Texte)</div></div>';
  h+='<div class="nav-item" onclick="state.view=\'db-terrain\';render();"><div class="nav-icon orange">'+ICONS.search+'</div><div class="nav-label">Base de données terrain</div><div class="nav-count">'+state.agentsDB.length+'</div></div>';
  h+='<div class="nav-item" onclick="state.view=\'db-full\';render();"><div class="nav-icon purple">'+ICONS.database+'</div><div class="nav-label">Base de données complète</div></div></div>';
  h+='<input type="file" id="import-mission-input" accept=".json" style="display:none;" onchange="handleImportMission(event);">';
  if(state.showModal==='importQR')h+=renderImportQRModal();
  h+='<div class="version-info">Version 3.6 © 2025 Quentin THOMAS</div>';
  return h;
}

function renderPrepaList(){
  var h='<button class="back-btn" onclick="state.view=\'home\';render();">'+ICONS.arrowLeft+' Accueil</button>';
  h+='<div class="card"><h1>'+ICONS.building+' Préparation mission</h1><p class="subtitle">Préparez vos missions au bureau</p><button class="btn btn-primary mt-12" onclick="createNewMission();">'+ICONS.plus+' Nouvelle mission</button></div>';
  var p=state.missions.filter(function(m){return m.status==='prepa';});
  var v=state.missions.filter(function(m){return m.status==='validee';});
  if(p.length===0&&v.length===0){
    h+='<div class="empty-state"><div class="empty-state-icon">'+ICONS.empty+'</div><p>Aucune mission</p></div>';
  }else{
    if(p.length>0){h+='<div class="section-title">En préparation</div>';p.forEach(function(m){h+=renderMissionCard(m);});}
    if(v.length>0){h+='<div class="section-title">Validées</div>';v.forEach(function(m){h+=renderMissionCard(m);});}
  }
  return h;
}

function renderMissionCard(m){
  var gc=m.gehs.filter(function(g){return g.name;}).length;
  var ac=m.agents.length;
  var pc=countPrelevements(m);
  var h='<div class="mission-card mission-card-'+m.status+'"><div class="mission-title">'+escapeHtml(m.clientSite||'Sans nom')+'<span class="status-badge status-'+m.status+'">'+(m.status==='prepa'?'Prépa':'Validée')+'</span></div>';
  h+='<div class="mission-info">'+gc+' GEH • '+ac+' agents • '+pc+' prél.</div><div class="mission-actions">';
  h+='<button class="btn btn-gray btn-small" onclick="openMission('+m.id+');">'+ICONS.edit+'</button>';
  h+='<button class="btn btn-blue btn-small" onclick="copyMission('+m.id+');">'+ICONS.copy+'</button>';
  if(m.status==='prepa')h+='<button class="btn btn-success btn-small" onclick="validateMission('+m.id+');">'+ICONS.check+' Valider</button>';
  else h+='<button class="btn btn-primary btn-small" onclick="goToTerrain('+m.id+');">'+ICONS.play+' Terrain</button>';
  h+='</div></div>';
  return h;
}

function countPrelevements(m){
  var c=0;
  for(var an in m.affectations){
    var a=m.affectations[an];
    for(var gid in a.gehs){
      var g=a.gehs[gid];
      if(g.has8h)c+=(a.isReg!==false?3:1);
      if(g.hasCT)c+=1;
    }
  }
  return c;
}

function createNewMission(){
  var m=createEmptyMission();
  state.missions.push(m);
  saveData('vlep_missions_v3',state.missions);
  state.currentMissionId=m.id;
  state.showModal='editInfo';
  state.view='prepa-mission';
  render();
}

function openMission(id){state.currentMissionId=id;state.view='prepa-mission';render();}

function copyMission(id){
  var o=state.missions.find(function(m){return m.id===id;});
  if(!o)return;
  var c=JSON.parse(JSON.stringify(o));
  c.id=generateId();
  c.status='prepa';
  c.clientSite=o.clientSite+' (copie)';
  c.prelevements=[];
  c.conditionsAmbiantes=[];
  c.gehs.forEach(function(g){g.id=generateId();});
  state.missions.push(c);
  saveData('vlep_missions_v3',state.missions);
  render();
}

function validateMission(id){
  var m=state.missions.find(function(x){return x.id===id;});
  if(!m)return;
  generatePrelevements(m);
  if(m.prelevements.length===0){
    alert('Aucun prélèvement à générer.\n\nVérifiez :\n1. Au moins un GEH avec nom\n2. Au moins un agent avec 8h ou CT\n3. Des affectations agents ↔ GEH');
    return;
  }
  m.status='validee';
  saveData('vlep_missions_v3',state.missions);
  render();
}

// FIX #8: Le statut réglementaire est maintenant géré indépendamment pour 8h et CT
function generatePrelevements(m){
  m.prelevements=[];
  for(var an in m.affectations){
    var a=m.affectations[an];
    if(!an||an==='undefined')continue;
    var c=getAgentColor(m,an);
    for(var gid in a.gehs){
      var ga=a.gehs[gid];
      var g=m.gehs.find(function(x){return String(x.id)===String(gid);});
      if(!g||!g.name)continue;
      // Utiliser isReg8h pour le 8h
      var isReg8h=(ga.isReg8h!==undefined)?ga.isReg8h:((ga.isReg!==undefined)?ga.isReg:((a.isReg!==undefined)?a.isReg:true));
      // Utiliser isRegCT pour le CT
      var isRegCT=(ga.isRegCT!==undefined)?ga.isRegCT:((ga.isReg!==undefined)?ga.isReg:((a.isReg!==undefined)?a.isReg:true));
      
      if(ga.has8h){
        var ns=isReg8h?3:1;
        var p={id:generateId(),gehId:g.id,gehName:g.name,gehNum:g.num,agents:[{name:an,color:c}],type:'8h',isReglementaire:isReg8h,subPrelevements:[]};
        for(var s=0;s<ns;s++){
          var sb={id:generateId(),operateur:'',date:'',plages:[{debut:'',fin:''}],observations:'',completed:false,agentData:{}};
          sb.agentData[an]={refEchantillon:'',numPompe:'',debitInitial:'',debitFinal:''};
          p.subPrelevements.push(sb);
        }
        m.prelevements.push(p);
      }
      if(ga.hasCT){
        var nsCT=isRegCT?3:1;
        var pct={id:generateId(),gehId:g.id,gehName:g.name,gehNum:g.num,agents:[{name:an,color:lightenColor(c,0.4)}],type:'CT',isReglementaire:isRegCT,subPrelevements:[]};
        for(var sCT=0;sCT<nsCT;sCT++){
          var sbCT={id:generateId(),operateur:'',date:'',plages:[{debut:'',fin:''}],observations:'',completed:false,agentData:{}};
          sbCT.agentData[an]={refEchantillon:'',numPompe:'',debitInitial:'',debitFinal:''};
          pct.subPrelevements.push(sbCT);
        }
        m.prelevements.push(pct);
      }
    }
  }
}

function goToTerrain(id){
  state.currentMissionId=id;
  state.view='terrain-mission';
  state.expandedGeh={};
  state.fusionMode=false;
  state.selectedForFusion=[];
  render();
}

function renderPrepaMission(){
  var m=getCurrentMission();
  if(!m){state.view='prepa-list';render();return'';}
  var gc=m.gehs.filter(function(g){return g.name;}).length;
  var ac=m.agents.length;
  var pc=countPrelevements(m);
  var h='<button class="back-btn" onclick="state.view=\'prepa-list\';state.currentMissionId=null;render();">'+ICONS.arrowLeft+' Liste</button>';
  h+='<div class="card"><h2>'+ICONS.clipboard+' '+escapeHtml(m.clientSite||'Nouvelle mission')+'</h2><div class="info-box mt-12"><p><span class="svg-icon">'+ICONS.user+'</span> Préleveur : <strong>'+escapeHtml(m.preleveur||'-')+'</strong></p><p><span class="svg-icon">'+ICONS.tool+'</span> Débitmètre : <strong>'+escapeHtml(m.debitmetre||'-')+'</strong></p></div><button class="btn btn-gray btn-small mt-12" onclick="state.showModal=\'editInfo\';render();">'+ICONS.edit+' Modifier infos</button></div>';
  var step1=gc>0;var step2=ac>0;var step3=pc>0;
  h+='<div class="info-box mt-12"><p><strong>Étapes de préparation :</strong></p><p>'+(step1?'<span style="color:var(--accent);display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>':'<span style="opacity:0.3;display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>')+' 1. Définir les GEH ('+(gc||'aucun')+')</p><p>'+(step2?'<span style="color:var(--accent);display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>':'<span style="opacity:0.3;display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>')+' 2. Sélectionner les agents ('+(ac||'aucun')+')</p><p>'+(step3?'<span style="color:var(--accent);display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>':'<span style="opacity:0.3;display:inline-flex;width:14px;height:14px;vertical-align:middle;">'+ICONS.check+'</span>')+' 3. Affecter agents / GEH ('+(pc||'aucun')+' prél.)</p></div>';
  h+='<div class="nav-menu"><div class="nav-item" onclick="state.view=\'prepa-geh\';render();"><div class="nav-icon">'+ICONS.folder+'</div><div class="nav-label">1. GEH</div><div class="nav-count">'+gc+'</div></div><div class="nav-item" onclick="state.view=\'prepa-agents\';state.searchText=\'\';render();"><div class="nav-icon green">'+ICONS.beaker+'</div><div class="nav-label">2. Agents chimiques</div><div class="nav-count">'+ac+'</div></div></div>';
  if(ac>0&&gc>0)h+='<button class="btn btn-orange" onclick="state.view=\'prepa-affectations\';render();">'+ICONS.link+' 3. Affecter agents aux GEH</button>';
  h+='<div class="info-box info-box-success mt-12"><p><strong>Récap :</strong> '+gc+' GEH • '+ac+' agents • '+pc+' prélèvements</p></div>';
  h+='<div class="row">';
  if(m.status==='prepa'){
    if(pc>0)h+='<button class="btn btn-success" onclick="validateMission('+m.id+');">'+ICONS.check+' Valider ('+pc+')</button>';
    else h+='<button class="btn btn-gray" disabled>'+ICONS.check+' Valider</button>';
  }else{
    h+='<button class="btn btn-primary" onclick="goToTerrain('+m.id+');">'+ICONS.play+' Terrain</button>';
    h+='<button class="btn btn-gray btn-small" onclick="unvalidateMission('+m.id+');">'+ICONS.arrowLeft+' Prépa</button>';
  }
  h+='<button class="btn btn-danger btn-icon" onclick="deleteMission('+m.id+');">'+ICONS.trash+'</button>';
  h+='</div>';
  h+='<div class="row mt-8"><button class="btn btn-gray" style="flex:1;" onclick="exportMissionJSON('+m.id+');">'+ICONS.download+' Export JSON</button><button class="btn btn-primary" style="flex:1;" onclick="showQRCodeModal('+m.id+');">'+ICONS.share+' QR Code</button></div>';
  if(m.status==='prepa')h+='<button class="btn btn-primary mt-8" onclick="state.showModal=\'prepaAuto\';state.prepaAutoData=null;render();" style="background:linear-gradient(135deg,var(--purple),#a78bfa);">'+ICONS.zap+' Prépa automatique (devis)</button>';
  if(state.showModal==='editInfo')h+=renderEditInfoModal(m);
  if(state.showModal==='prepaAuto')h+=renderPrepaAutoModal(m);
  if(state.showModal==='qrCode')h+=renderQRCodeModal();
  return h;
}

function renderEditInfoModal(m){
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>Infos mission</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div><div class="field"><label class="label">Client / Site *</label><input type="text" class="input" id="edit-clientsite" value="'+escapeHtml(m.clientSite)+'" placeholder="Ex: Entreprise ABC - Usine Nord"></div><div class="field"><label class="label">Préleveur</label><input type="text" class="input" id="edit-preleveur" value="'+escapeHtml(m.preleveur)+'"></div><div class="field"><label class="label">Débitmètre</label><input type="text" inputmode="numeric" class="input" id="edit-debitmetre" value="'+escapeHtml(m.debitmetre)+'"></div><div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-primary" onclick="saveEditInfo();">Enregistrer</button></div></div></div>';
  return h;
}

function saveEditInfo(){
  var m=getCurrentMission();if(!m)return;
  var cs=document.getElementById('edit-clientsite');
  var pr=document.getElementById('edit-preleveur');
  var db=document.getElementById('edit-debitmetre');
  if(cs)m.clientSite=cs.value.trim();
  if(pr)m.preleveur=pr.value.trim();
  if(db)m.debitmetre=db.value.trim();
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  render();
}

// ═══════════════════════════════════════════════════════════════════════════════
// PRÉPA AUTOMATIQUE - Import depuis tableau devis
// © 2025 Quentin THOMAS
// ═══════════════════════════════════════════════════════════════════════════════

function renderPrepaAutoModal(m){
  if(!state.prepaAutoData)state.prepaAutoData={format:'1',devisText:'',gehListText:'',parsed:null,error:null};
  var d=state.prepaAutoData;
  
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;state.prepaAutoData=null;render();}"><div class="modal-content" style="max-height:92vh;overflow-y:auto;"><div class="modal-header"><h2>'+ICONS.zap+' Prépa automatique</h2><button class="close-btn" onclick="state.showModal=null;state.prepaAutoData=null;render();">×</button></div>';
  
  // Choix du format
  h+='<div class="field"><label class="label">Format du devis</label><div class="row">';
  h+='<button class="btn btn-small '+(d.format==='1'?'btn-primary':'btn-gray')+'" onclick="state.prepaAutoData.format=\'1\';state.prepaAutoData.parsed=null;render();">Format 1 : N° GEH</button>';
  h+='<button class="btn btn-small '+(d.format==='2'?'btn-primary':'btn-gray')+'" onclick="state.prepaAutoData.format=\'2\';state.prepaAutoData.parsed=null;render();">Format 2 : Noms GEH</button>';
  h+='</div></div>';
  
  // Instructions
  if(d.format==='1'){
    h+='<div class="info-box"><p><strong>Format 1 :</strong> Collez le tableau du devis</p><p style="font-size:11px;margin-top:4px;">Colonnes attendues : Agent chimique | N° GEH | Nb prélèvements | Type VLEP</p><p style="font-size:11px;margin-top:2px;">+ Collez la liste des GEH (N° | Nom) en dessous</p></div>';
  }else{
    h+='<div class="info-box"><p><strong>Format 2 :</strong> Collez le tableau du devis</p><p style="font-size:11px;margin-top:4px;">Colonnes attendues : Agent chimique | Noms GEH | Nb prélèvements | Type VLEP</p></div>';
  }
  
  // Zone de saisie devis
  h+='<div class="field"><label class="label">Tableau du devis (copier/coller depuis Excel)</label><textarea class="input" id="prepa-auto-devis" rows="6" placeholder="Collez ici le tableau du devis..." style="font-size:12px;font-family:monospace;">'+escapeHtml(d.devisText)+'</textarea></div>';
  
  // Zone GEH si format 1
  if(d.format==='1'){
    h+='<div class="field"><label class="label">Liste des GEH (N° + Nom)</label><textarea class="input" id="prepa-auto-gehlist" rows="4" placeholder="Ex:\n1\tDécoupe LM\n2\tDécoupe SHW\n..." style="font-size:12px;font-family:monospace;">'+escapeHtml(d.gehListText)+'</textarea></div>';
  }
  
  // Bouton analyser
  h+='<button class="btn btn-primary" onclick="parsePrepaAuto();">'+ICONS.search+' Analyser le devis</button>';
  
  // Afficher erreur
  if(d.error){
    h+='<div class="info-box info-box-warning mt-12"><p>'+escapeHtml(d.error)+'</p></div>';
  }
  
  // Afficher aperçu si parsé
  if(d.parsed){
    var p=d.parsed;
    h+='<div class="section-title mt-12">Aperçu</div>';
    
    // GEH détectés
    h+='<div class="card" style="padding:10px;"><div style="font-weight:700;font-size:13px;margin-bottom:6px;">'+ICONS.folder+' '+p.gehs.length+' GEH détectés</div>';
    p.gehs.forEach(function(g){
      h+='<div style="font-size:12px;color:var(--text-muted);padding:2px 0;">'+g.num+'. '+escapeHtml(g.name)+'</div>';
    });
    h+='</div>';
    
    // Agents et affectations
    h+='<div class="card" style="padding:10px;"><div style="font-weight:700;font-size:13px;margin-bottom:6px;">'+ICONS.beaker+' '+p.agents.length+' agent(s) chimique(s)</div>';
    p.rows.forEach(function(r){
      var regLabel=r.isReg?'<span style="color:#047857;font-size:10px;font-weight:700;"> REG</span>':'<span style="color:#b45309;font-size:10px;font-weight:700;"> NR</span>';
      h+='<div style="background:#f8fafc;border-radius:6px;padding:8px;margin-bottom:6px;border-left:3px solid var(--primary);">';
      r.agentNames.forEach(function(an){
        h+='<div style="font-size:12px;font-weight:600;">'+escapeHtml(an)+'</div>';
      });
      h+='<div style="font-size:11px;color:var(--text-muted);margin-top:3px;">'+r.type+regLabel+' → '+r.gehNums.length+' GEH × '+(r.isReg?'3':'1')+' = '+(r.gehNums.length*(r.isReg?3:1))+' sous-prél.</div>';
      h+='</div>';
    });
    h+='</div>';
    
    // Résumé
    var totalPrel=0;
    p.rows.forEach(function(r){totalPrel+=r.gehNums.length*(r.isReg?3:1);});
    h+='<div class="info-box info-box-success"><p><strong>Total :</strong> '+p.gehs.length+' GEH • '+p.agents.length+' agents • '+totalPrel+' sous-prélèvements</p></div>';
    
    // Avertissements agents non trouvés dans la DB
    var notInDB=[];
    p.agents.forEach(function(an){
      if(!getAgentFromDB(an))notInDB.push(an);
    });
    if(notInDB.length>0){
      h+='<div class="info-box info-box-warning mt-8"><p><strong>'+notInDB.length+' agent(s) non trouvé(s) dans la base :</strong></p>';
      notInDB.forEach(function(an){
        h+='<p style="font-size:11px;">• '+escapeHtml(an)+'</p>';
      });
      h+='<p style="font-size:11px;margin-top:4px;">Ils seront ajoutés en mode "manuel"</p></div>';
    }
    
    // Bouton appliquer
    h+='<div class="row mt-12"><button class="btn btn-gray" onclick="state.showModal=null;state.prepaAutoData=null;render();">Annuler</button><button class="btn btn-success" onclick="applyPrepaAuto();">'+ICONS.check+' Appliquer à la mission</button></div>';
  }
  
  h+='</div></div>';
  return h;
}

function parsePrepaAuto(){
  var d=state.prepaAutoData;
  d.error=null;
  d.parsed=null;
  
  // Lire les textareas
  var devisEl=document.getElementById('prepa-auto-devis');
  var gehListEl=document.getElementById('prepa-auto-gehlist');
  d.devisText=devisEl?devisEl.value:'';
  d.gehListText=gehListEl?gehListEl.value:'';
  
  if(!d.devisText.trim()){
    d.error='Collez le tableau du devis';
    render();return;
  }
  
  try{
    // Parser les lignes du devis
    var devisLines=parseTSVLines(d.devisText);
    if(devisLines.length===0){d.error='Aucune ligne valide détectée';render();return;}
    
    // Détecter si la première ligne est un en-tête
    var firstLine=devisLines[0];
    var isHeader=false;
    if(firstLine.length>=2){
      var col0=(firstLine[0]||'').toLowerCase();
      if(col0.indexOf('agent')!==-1||col0.indexOf('chimique')!==-1||col0.indexOf('substance')!==-1||col0.indexOf('paramètre')!==-1){
        isHeader=true;
      }
    }
    if(isHeader)devisLines.shift();
    
    // Parser la liste GEH (format 1)
    var gehMap={};
    if(d.format==='1'){
      if(!d.gehListText.trim()){
        d.error='Format 1 : collez aussi la liste des GEH (N° + Nom)';
        render();return;
      }
      var gehLines=parseTSVLines(d.gehListText);
      // Détecter header GEH
      if(gehLines.length>0){
        var gh0=(gehLines[0][0]||'').toLowerCase();
        if(gh0.indexOf('geh')!==-1||gh0.indexOf('n°')!==-1||gh0.indexOf('désignation')!==-1){
          gehLines.shift();
        }
      }
      // Parser : peut être "N° \t Nom" ou "N° Nom" sur chaque ligne
      gehLines.forEach(function(cols){
        if(cols.length>=2&&cols[0].trim()&&cols[1].trim()){
          var num=parseInt(cols[0].trim());
          if(!isNaN(num)){
            gehMap[num]=cols[1].trim();
          }
        }else if(cols.length===1||cols.length>=1){
          // Essayer format "1 Nom du GEH" ou "1\tNom"
          var txt=cols.join('\t').trim();
          var match=txt.match(/^(\d+)\s+(.+)/);
          if(match){
            gehMap[parseInt(match[1])]=match[2].trim();
          }
        }
      });
      
      // Aussi tenter un format inline "N° GEH \t Désignation 1 \t NomGEH1 2 \t NomGEH2..."
      if(Object.keys(gehMap).length===0){
        // Essayer de parser la liste en un seul bloc
        var allText=d.gehListText;
        var matches=allText.match(/(\d+)\s+([^\d]+)/g);
        if(matches){
          matches.forEach(function(m){
            var mm=m.match(/^(\d+)\s+(.+)/);
            if(mm)gehMap[parseInt(mm[1])]=mm[2].trim();
          });
        }
      }
      
      // Essayer format inline avec tabs : "Header \t Name1 N1 \t Name2 N2 \t ..."
      // Ou : "Header \t N1 \t Name1 \t N2 \t Name2 \t ..."
      if(Object.keys(gehMap).length===0&&gehLines.length>0){
        var flatCols=gehLines[0];
        // Format: [Header, Header2, N1, Name1, N2, Name2, ...]
        for(var ci=0;ci<flatCols.length-1;ci++){
          var numVal=parseInt(flatCols[ci]);
          if(!isNaN(numVal)&&numVal>0&&flatCols[ci+1]&&isNaN(parseInt(flatCols[ci+1]))){
            gehMap[numVal]=flatCols[ci+1].trim();
            ci++; // skip next
          }
        }
      }
      
      // Format: "Name1 N1 \t Name2 N2 \t ..." (nombre à la fin)
      if(Object.keys(gehMap).length===0&&gehLines.length>0){
        var flatCols2=gehLines[0];
        flatCols2.forEach(function(cell){
          var match2=cell.match(/^(.+?)\s+(\d+)\s*$/);
          if(match2){
            gehMap[parseInt(match2[2])]=match2[1].trim();
          }
        });
      }
      
      // Format: texte continu avec pattern "N NomGEH"
      if(Object.keys(gehMap).length===0){
        var fullText=d.gehListText.replace(/\t/g,' ');
        var re=/(\d+)\s+([A-ZÀ-Ú][^\d]*?)(?=\s+\d+\s|$)/gi;
        var m2;
        while((m2=re.exec(fullText))!==null){
          var nn=parseInt(m2[1]);
          var nm=m2[2].trim();
          if(nn>0&&nm.length>1)gehMap[nn]=nm;
        }
      }
      
      if(Object.keys(gehMap).length===0){
        d.error='Impossible de parser la liste des GEH. Format attendu :\n1\\tNom GEH 1\\n2\\tNom GEH 2\\n...';
        render();return;
      }
    }
    
    // Parser chaque ligne du devis
    var rows=[];
    var allAgents=[];
    var allGehNums={};
    
    devisLines.forEach(function(cols){
      if(cols.length<3)return;
      
      // Col 0 : Agent(s) chimique(s) - peut contenir plusieurs lignes
      var agentRaw=cols[0]||'';
      var agentNames=parseAgentNames(agentRaw);
      if(agentNames.length===0)return;
      
      // Col 1 : GEH (numéros ou noms séparés par " - ")
      var gehRaw=cols[1]||'';
      var gehNums=parseGehColumn(gehRaw,d.format,gehMap);
      if(gehNums.length===0)return;
      
      // Col 2 : Nb prélèvements
      var nbRaw=(cols[2]||'').trim().toLowerCase();
      var isReg=true;
      if(nbRaw.indexOf('1')!==-1&&nbRaw.indexOf('3')===-1)isReg=false;
      
      // Col 3 : Type VLEP
      var typeRaw=(cols[3]||'8h').trim().toUpperCase();
      var type=typeRaw.indexOf('CT')!==-1?'CT':'8h';
      
      // Collecter
      agentNames.forEach(function(an){
        if(allAgents.indexOf(an)===-1)allAgents.push(an);
      });
      gehNums.forEach(function(gn){allGehNums[gn]=true;});
      
      rows.push({
        agentNames:agentNames,
        gehNums:gehNums,
        isReg:isReg,
        type:type
      });
    });
    
    if(rows.length===0){
      d.error='Aucun prélèvement détecté. Vérifiez le format du tableau.';
      render();return;
    }
    
    // Construire la liste des GEH
    var gehs=[];
    var sortedNums=Object.keys(allGehNums).map(Number).sort(function(a,b){return a-b;});
    sortedNums.forEach(function(num){
      var name=gehMap[num]||('GEH '+num);
      gehs.push({num:num,name:name});
    });
    
    d.parsed={
      gehs:gehs,
      agents:allAgents,
      rows:rows,
      gehMap:gehMap
    };
    
  }catch(e){
    d.error='Erreur d\'analyse : '+e.message;
  }
  
  render();
}

function parseTSVLines(text){
  var result=[];
  var lines=[];
  var current='';
  var inQuote=false;
  
  for(var i=0;i<text.length;i++){
    var c=text[i];
    if(c==='"'){
      inQuote=!inQuote;
      current+=c;
    }else if(c==='\n'&&!inQuote){
      if(current.trim())lines.push(current);
      current='';
    }else{
      current+=c;
    }
  }
  if(current.trim())lines.push(current);
  
  lines.forEach(function(line){
    var cols=[];
    var cell='';
    var q=false;
    for(var i=0;i<line.length;i++){
      var c=line[i];
      if(c==='"')q=!q;
      else if(c==='\t'&&!q){
        cols.push(cell.replace(/^"|"$/g,'').trim());
        cell='';
      }else{
        cell+=c;
      }
    }
    cols.push(cell.replace(/^"|"$/g,'').trim());
    result.push(cols);
  });
  
  return result;
}

function parseAgentNames(raw){
  var names=[];
  // Séparer par retour à la ligne dans une cellule
  var parts=raw.split(/\n|\r\n|\r/);
  parts.forEach(function(p){
    var t=p.replace(/^["'\s]+|["'\s]+$/g,'').trim();
    // Ignorer les lignes qui sont des commentaires comme "Analyse TOXILABO"
    if(!t)return;
    if(t.toLowerCase().indexOf('analyse ')===0)return;
    // Ajouter si c'est un nom valide
    if(t.length>1)names.push(t);
  });
  return names;
}

function parseGehColumn(raw,format,gehMap){
  var nums=[];
  // Les GEH sont séparés par " - " ou "-" avec espaces
  var parts=raw.split(/\s*-\s*/);
  
  if(format==='1'){
    // Numéros
    parts.forEach(function(p){
      var n=parseInt(p.trim());
      if(!isNaN(n)&&n>0)nums.push(n);
    });
  }else{
    // Noms directs - on les ajoute comme numéros séquentiels
    // On crée un mapping name->num
    var nextNum=1;
    parts.forEach(function(p){
      var name=p.trim();
      if(!name)return;
      // Chercher dans gehMap si un num existe déjà pour ce nom
      var found=false;
      for(var num in gehMap){
        if(gehMap[num]===name){
          nums.push(parseInt(num));
          found=true;
          break;
        }
      }
      if(!found){
        // Ajouter un nouveau GEH
        while(gehMap[nextNum])nextNum++;
        gehMap[nextNum]=name;
        nums.push(nextNum);
        nextNum++;
      }
    });
  }
  
  return nums;
}

function applyPrepaAuto(){
  var m=getCurrentMission();
  if(!m||!state.prepaAutoData||!state.prepaAutoData.parsed)return;
  var p=state.prepaAutoData.parsed;
  
  var confirm1=confirm('Appliquer la prépa automatique ?\n\nCela va remplacer les GEH, agents et affectations actuels.\n\n'+p.gehs.length+' GEH • '+p.agents.length+' agents');
  if(!confirm1)return;
  
  // 1. Créer les GEH
  m.gehs=[];
  p.gehs.forEach(function(g){
    m.gehs.push({id:generateId(),num:g.num,name:g.name});
  });
  
  // 2. Créer les agents
  m.agents=[];
  var agentTypes={};// agentName -> {is8h, isCT}
  p.rows.forEach(function(r){
    r.agentNames.forEach(function(an){
      if(!agentTypes[an])agentTypes[an]={is8h:false,isCT:false};
      if(r.type==='8h')agentTypes[an].is8h=true;
      if(r.type==='CT')agentTypes[an].isCT=true;
    });
  });
  
  p.agents.forEach(function(an){
    var inDB=getAgentFromDB(an);
    var types=agentTypes[an]||{is8h:true,isCT:false};
    m.agents.push({
      name:an,
      is8h:types.is8h||(!types.is8h&&!types.isCT),
      isCT:types.isCT,
      isManual:!inDB
    });
  });
  
  // 3. Créer les affectations
  m.affectations={};
  m.agentColors={};
  
  p.rows.forEach(function(r){
    r.agentNames.forEach(function(an){
      if(!m.affectations[an])m.affectations[an]={gehs:{}};
      var c=getAgentColor(m,an);
      
      r.gehNums.forEach(function(gNum){
        // Trouver le GEH correspondant
        var geh=m.gehs.find(function(g){return g.num===gNum;});
        if(!geh)return;
        
        if(!m.affectations[an].gehs[geh.id]){
          m.affectations[an].gehs[geh.id]={has8h:false,hasCT:false,isReg8h:true,isRegCT:true};
        }
        var gaf=m.affectations[an].gehs[geh.id];
        
        if(r.type==='8h'){
          gaf.has8h=true;
          gaf.isReg8h=r.isReg;
        }
        if(r.type==='CT'){
          gaf.hasCT=true;
          gaf.isRegCT=r.isReg;
        }
      });
    });
  });
  
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  state.prepaAutoData=null;
  render();
  
  var totalPrel=countPrelevements(m);
  alert('Prépa automatique appliquée !\n\n'+m.gehs.filter(function(g){return g.name;}).length+' GEH\n'+m.agents.length+' agents\n'+totalPrel+' prélèvements\n\nVérifiez les affectations et validez quand tout est bon.');
}

function unvalidateMission(id){
  var m=state.missions.find(function(x){return x.id===id;});
  if(m){m.status='prepa';m.prelevements=[];saveData('vlep_missions_v3',state.missions);render();}
}
function unvalidateMissionFromTerrain(){
  var m=getCurrentMission();
  if(!m)return;
  if(!confirm('Repasser cette mission en préparation ?\n\nToutes les données terrain seront conservées.'))return;
  m.status='prepa';
  saveData('vlep_missions_v3',state.missions);
  state.view='prepa-list';
  state.currentMissionId=null;
  render();
}


function deleteMission(id){
  if(confirm('Supprimer cette mission ?')){
    state.missions=state.missions.filter(function(m){return m.id!==id;});
    saveData('vlep_missions_v3',state.missions);
    state.currentMissionId=null;
    state.view='prepa-list';
    render();
  }
}

// FIX #3: Correction du bug de recherche d'agents - pas de render() complet
function renderPrepaAgents(){
  var m=getCurrentMission();
  if(!m){state.view='prepa-list';render();return'';}
  var h='<button class="back-btn" onclick="state.view=\'prepa-mission\';render();">'+ICONS.arrowLeft+' Mission</button><div class="card"><h2>'+ICONS.beaker+' Agents chimiques</h2><p class="subtitle">Sélectionnez les ACD pour cette mission</p></div>';
  h+='<div class="search-box"><span class="search-icon">'+ICONS.search+'</span><input type="text" class="search-input" id="agent-search" placeholder="Rechercher un agent..." value="'+escapeHtml(state.searchText)+'" oninput="handleAgentSearchInput(this.value);"></div>';
  h+='<div id="search-results-container">';
  if(state.searchText.length>=2){
    var r=searchAgentsDB(state.searchText);
    var f=r.filter(function(x){return!m.agents.some(function(a){return a.name===x;});});
    if(f.length>0){
      h+='<div class="search-results">';
      f.slice(0,10).forEach(function(x,idx){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addAgentFromSearch(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  h+='</div>';
  h+='<button class="btn btn-gray" onclick="state.showModal=\'addManual\';render();">+ Ajouter manuellement</button><div class="section-title">Agents sélectionnés ('+m.agents.length+')</div>';
  if(m.agents.length===0)h+='<div class="empty-state"><p>Aucun agent sélectionné</p></div>';
  else m.agents.forEach(function(a,i){
    var c=getAgentColor(m,a.name);
    var h8=hasVLEP8h(a.name)||a.isManual;
    var hc=hasVLEPCT(a.name)||a.isManual;
    h+='<div class="agent-item"><div class="agent-color" style="background:'+c+';"></div><div class="agent-name">'+escapeHtml(a.name)+(a.isManual?' <small>(manuel)</small>':'')+'</div><div class="agent-badges"><span class="agent-badge agent-badge-8h '+(a.is8h?'active':'')+'" onclick="toggleAgent8h('+i+');">8h</span><span class="agent-badge agent-badge-ct '+(a.isCT?'active':'')+'" onclick="toggleAgentCT('+i+');">CT</span></div><button class="agent-delete" onclick="removeAgent('+i+');">'+ICONS.trash+'</button></div>';
  });
  if(state.showModal==='addManual')h+=renderAddManualModal();
  return h;
}

// FIX #3: Nouveau handler qui ne fait pas de render() complet
function handleAgentSearchInput(value){
  state.searchText=value;
  updateSearchResultsOnly();
}

function updateSearchResultsOnly(){
  var container=document.getElementById('search-results-container');
  if(!container)return;
  var m=getCurrentMission();
  if(!m)return;
  var h='';
  if(state.searchText.length>=2){
    var r=searchAgentsDB(state.searchText);
    var f=r.filter(function(x){return!m.agents.some(function(a){return a.name===x;});});
    if(f.length>0){
      h+='<div class="search-results">';
      f.slice(0,10).forEach(function(x){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addAgentFromSearch(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  container.innerHTML=h;
}

function addAgentFromSearch(n){
  var m=getCurrentMission();
  if(!m||m.agents.some(function(a){return a.name===n;}))return;
  m.agents.push({name:n,is8h:hasVLEP8h(n),isCT:hasVLEPCT(n),isManual:false});
  state.searchText='';
  saveData('vlep_missions_v3',state.missions);
  render();
}

function searchAgentsDB(t){
  var s=t.toLowerCase();
  return state.agentsDB.filter(function(a){
    return(a['Agent chimique']||'').toLowerCase().indexOf(s)!==-1;
  }).map(function(a){return a['Agent chimique'];});
}

function addAgent(n){
  var m=getCurrentMission();
  if(!m||m.agents.some(function(a){return a.name===n;}))return;
  m.agents.push({name:n,is8h:hasVLEP8h(n),isCT:hasVLEPCT(n),isManual:false});
  state.searchText='';
  saveData('vlep_missions_v3',state.missions);
  render();
}

function renderAddManualModal(){
  return'<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>Ajouter agent</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div><div class="field"><label class="label">Nom de l\'agent</label><input type="text" class="input" id="manual-name" placeholder="Ex: Benzène"></div><div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-primary" onclick="addManualAgent();">Ajouter</button></div></div></div>';
}

function addManualAgent(){
  var n=document.getElementById('manual-name').value.trim();
  if(!n){alert('Saisissez un nom');return;}
  var m=getCurrentMission();
  if(!m||m.agents.some(function(a){return a.name===n;})){alert('Agent déjà ajouté');return;}
  m.agents.push({name:n,is8h:true,isCT:true,isManual:true});
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  render();
}



function removeAgent(i){
  var m=getCurrentMission();if(!m)return;
  var an=m.agents[i].name;
  m.agents.splice(i,1);
  delete m.affectations[an];
  saveData('vlep_missions_v3',state.missions);
  render();
}
function toggleAgent8h(i){
  var m=getCurrentMission();if(!m)return;
  var a=m.agents[i];
  a.is8h=!a.is8h;
  if(!a.is8h&&!a.isCT)a.isCT=true;
  saveData('vlep_missions_v3',state.missions);
  render();
}

function toggleAgentCT(i){
  var m=getCurrentMission();if(!m)return;
  var a=m.agents[i];
  a.isCT=!a.isCT;
  if(!a.is8h&&!a.isCT)a.is8h=true;
  saveData('vlep_missions_v3',state.missions);
  render();
}


function renderPrepaGeh(){
  var m=getCurrentMission();
  if(!m){state.view='prepa-list';render();return'';}
  var h='<button class="back-btn" onclick="state.view=\'prepa-mission\';render();">'+ICONS.arrowLeft+' Mission</button><div class="card"><h2>'+ICONS.folder+' Groupes d\'Exposition Homogène</h2><p class="subtitle">Définissez les GEH pour cette mission</p></div><div class="section-title">GEH définis</div>';
  m.gehs.forEach(function(g,i){
    h+='<div class="geh-item"><div class="geh-num">'+g.num+'</div><input type="text" class="geh-input" value="'+escapeHtml(g.name)+'" placeholder="Nom du GEH..." onchange="updateGehName('+i+',this.value);"><button class="agent-delete" onclick="deleteGehPrepa('+i+');">'+ICONS.trash+'</button></div>';
  });
  h+='<button class="btn btn-primary" onclick="addGeh();">+ Ajouter un GEH</button>';
  return h;
}

function deleteGehPrepa(i){
  var m=getCurrentMission();if(!m)return;
  if(m.gehs.length<=1){alert('Vous devez garder au moins un GEH');return;}
  var geh=m.gehs[i];
  var msg='Supprimer ce GEH ?';
  if(geh.name)msg='Supprimer le GEH "'+geh.name+'" ?';
  if(!confirm(msg))return;
  // Supprimer les affectations liées
  for(var an in m.affectations){
    if(m.affectations[an].gehs&&m.affectations[an].gehs[geh.id]){
      delete m.affectations[an].gehs[geh.id];
    }
  }
  m.gehs.splice(i,1);
  // Renuméroter
  m.gehs.forEach(function(g,idx){g.num=idx+1;});
  saveData('vlep_missions_v3',state.missions);
  render();
}

function updateGehName(i,v){
  var m=getCurrentMission();
  if(m&&m.gehs[i]){m.gehs[i].name=v.trim();saveData('vlep_missions_v3',state.missions);}
}

function addGeh(){
  var m=getCurrentMission();if(!m)return;
  m.gehs.push({id:generateId(),num:m.gehs.length+1,name:''});
  saveData('vlep_missions_v3',state.missions);
  render();
}

function renderPrepaAffectations(){
  var m=getCurrentMission();
  if(!m){state.view='prepa-list';render();return'';}
  var h='<button class="back-btn" onclick="state.view=\'prepa-mission\';render();">'+ICONS.arrowLeft+' Mission</button><div class="card"><h2>'+ICONS.link+' Affectations</h2><p class="subtitle">Attribuez les agents aux GEH</p></div>';
  var ga=m.gehs.filter(function(g){return g.name;});
  if(ga.length===0){
    h+='<div class="info-box info-box-warning"><p>Définissez d\'abord au moins un GEH avec un nom</p></div>';
    return h;
  }
  m.agents.forEach(function(ag){
    if(!m.affectations[ag.name])m.affectations[ag.name]={gehs:{}};
    var af=m.affectations[ag.name];
    var c=getAgentColor(m,ag.name);
    // Obtenir le statut réglementaire par défaut de l'agent depuis la DB
    var agentDB=getAgentFromDB(ag.name);
    var defaultIsReg=agentDB?(agentDB['Réglementaire']!=='Non'):true;
    h+='<div class="affect-card" style="border-left:4px solid '+c+';"><div class="affect-header"><div class="affect-agent">'+escapeHtml(ag.name)+'</div></div>';
    ga.forEach(function(g){
      if(!af.gehs[g.id])af.gehs[g.id]={has8h:false,hasCT:false,isReg8h:defaultIsReg,isRegCT:defaultIsReg};
      var gaf=af.gehs[g.id];
      // Migration: si isReg8h/isRegCT n'existent pas, utiliser isReg ou valeur par défaut
      if(gaf.isReg8h===undefined){
        gaf.isReg8h=(gaf.isReg!==undefined)?gaf.isReg:((af.isReg!==undefined)?af.isReg:defaultIsReg);
      }
      if(gaf.isRegCT===undefined){
        gaf.isRegCT=(gaf.isReg!==undefined)?gaf.isReg:((af.isReg!==undefined)?af.isReg:defaultIsReg);
      }
      var can8h=ag.is8h;
      var canCT=ag.isCT;
      h+='<div class="affect-geh-row"><div class="affect-geh-name">'+g.num+'. '+escapeHtml(g.name)+'</div><div class="affect-geh-badges">';
      h+='<span class="affect-mini-badge '+(gaf.has8h?'active-8h':'')+' '+(!can8h?'disabled':'')+'" onclick="toggleGehAffect(\''+escapeJs(ag.name)+'\','+g.id+',\'8h\');">8h</span>';
      if(gaf.has8h){
        h+='<button class="affect-reg-toggle-mini '+(gaf.isReg8h?'':'nonreg')+'" onclick="toggleGehAffectReg(\''+escapeJs(ag.name)+'\','+g.id+',\'8h\');" title="'+(gaf.isReg8h?'8h Réglementaire':'8h Non réglementaire')+'">'+(gaf.isReg8h?'R':'NR')+'</button>';
      }
      h+='<span class="affect-mini-badge '+(gaf.hasCT?'active-ct':'')+' '+(!canCT?'disabled':'')+'" onclick="toggleGehAffect(\''+escapeJs(ag.name)+'\','+g.id+',\'CT\');">CT</span>';
      if(gaf.hasCT){
        h+='<button class="affect-reg-toggle-mini '+(gaf.isRegCT?'':'nonreg')+'" onclick="toggleGehAffectReg(\''+escapeJs(ag.name)+'\','+g.id+',\'CT\');" title="'+(gaf.isRegCT?'CT Réglementaire':'CT Non réglementaire')+'">'+(gaf.isRegCT?'R':'NR')+'</button>';
      }
      h+='</div></div>';
    });
    h+='</div>';
  });
  saveData('vlep_missions_v3',state.missions);
  return h;
}

function toggleGehAffectReg(an,gid,type){
  var m=getCurrentMission();
  if(!m||!m.affectations[an]||!m.affectations[an].gehs[gid])return;
  var gaf=m.affectations[an].gehs[gid];
  if(type==='8h'){
    gaf.isReg8h=!gaf.isReg8h;
  }else if(type==='CT'){
    gaf.isRegCT=!gaf.isRegCT;
  }
  saveData('vlep_missions_v3',state.missions);
  render();
}

function toggleGehAffect(an,gid,t){
  var m=getCurrentMission();
  if(!m||!m.affectations[an])return;
  var ag=m.agents.find(function(a){return a.name===an;});
  if(!ag)return;
  if(t==='8h'&&!ag.is8h)return;
  if(t==='CT'&&!ag.isCT)return;
  var ga=m.affectations[an].gehs[gid];
  if(!ga)ga=m.affectations[an].gehs[gid]={has8h:false,hasCT:false};
  if(t==='8h')ga.has8h=!ga.has8h;
  else ga.hasCT=!ga.hasCT;
  saveData('vlep_missions_v3',state.missions);
  render();
}

function renderTerrainList(){
  var h='<button class="back-btn" onclick="state.view=\'home\';render();">'+ICONS.arrowLeft+' Accueil</button><div class="card"><h1>'+ICONS.clipboard+' Saisie terrain</h1><p class="subtitle">Missions prêtes pour le terrain</p></div>';
  h+='<button class="btn btn-success mb-12" onclick="openQuickEntry();">'+ICONS.zap+' Saisie rapide (sans prépa)</button>';
  var ml=state.missions.filter(function(m){return m.status==='validee'||m.status==='encours'||m.status==='terminee';});
  if(ml.length===0)h+='<div class="empty-state"><div class="empty-state-icon">'+ICONS.list+'</div><p>Aucune mission validée</p><p style="font-size:13px;margin-top:8px;">Validez d\'abord une mission dans Préparation</p></div>';
  else ml.forEach(function(m){
    var t=0,d=0;
    m.prelevements.forEach(function(p){p.subPrelevements.forEach(function(s){t++;if(s.completed)d++;});});
    var pct=t>0?Math.round(d/t*100):0;
    h+='<div class="mission-card mission-card-'+m.status+'" onclick="goToTerrain('+m.id+');"><div class="mission-title">'+escapeHtml(m.clientSite||'Sans nom')+'<span class="status-badge status-'+m.status+'">'+(m.status==='validee'?'Prête':(m.status==='encours'?'En cours':'Terminée'))+'</span></div><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%;"></div></div><div class="progress-text">'+d+'/'+t+' prélèvements ('+pct+'%)</div></div>';
  });
  return h;
}

function renderTerrainMission(){
  var m=getCurrentMission();
  if(!m){state.view='terrain-list';render();return'';}
  var h='<div class="sticky-header"><button class="back-btn" onclick="state.view=\'terrain-list\';state.currentMissionId=null;render();">'+ICONS.arrowLeft+' Liste</button><div style="display:flex;justify-content:space-between;align-items:center;"><div style="color:white;font-weight:700;font-size:14px;">'+escapeHtml(m.clientSite)+'</div><div class="row" style="gap:4px;"><button class="btn btn-gray btn-small btn-icon" onclick="unvalidateMissionFromTerrain();" title="Repasser en prépa" style="background:rgba(255,255,255,0.15);color:white;border:none;">'+ICONS.arrowLeft+'</button><button class="btn btn-danger btn-icon" onclick="deleteMissionTerrain();" style="width:24px;height:24px;">'+ICONS.trash+'</button></div></div></div>';
  h+='<div class="card" style="margin-top:4px;"><p class="subtitle"><span class="svg-icon">'+ICONS.user+'</span> '+escapeHtml(m.preleveur||'-')+' • <span class="svg-icon">'+ICONS.tool+'</span> '+escapeHtml(m.debitmetre||'-')+'</p></div>';
  h+='<div class="row mb-12"><button class="btn btn-gray" onclick="state.view=\'conditions\';render();">'+ICONS.thermometer+' Conditions</button><button class="btn btn-blue" onclick="state.view=\'liste-echantillons\';render();">'+ICONS.list+' Échantillons</button></div>';
  h+='<div class="row mb-12"><button class="btn btn-gray" style="flex:1;" onclick="exportMissionJSON('+m.id+');">'+ICONS.download+' Export JSON</button><button class="btn btn-primary" style="flex:1;" onclick="showQRCodeModal('+m.id+');">'+ICONS.share+' QR Code</button></div>';
  
  // Boutons d'ajout
  h+='<div class="row mb-12"><button class="btn btn-success btn-small" onclick="state.showModal=\'addGehTerrain\';render();">+ GEH</button><button class="btn btn-primary btn-small" onclick="state.showModal=\'addPrelTerrain\';render();">+ Prélèvement</button></div>';
  
  if(state.fusionMode){
    h+='<div class="info-box info-box-warning mb-12"><p><strong>Mode fusion manuelle actif</strong></p><p>Sélectionnez les prélèvements à fusionner (même GEH, même type)</p></div><div class="row mb-12"><button class="btn btn-gray" onclick="cancelFusion();">Annuler</button><button class="btn btn-success" onclick="doFusion();" '+(state.selectedForFusion.length<2?'disabled':'')+'>Fusionner ('+state.selectedForFusion.length+')</button></div>';
  }else{
    h+='<div class="row mb-12"><button class="btn btn-success" onclick="showSmartFusionModal();">'+ICONS.zap+' Fusionner intelligemment</button><button class="btn btn-orange" onclick="startFusionMode();">'+ICONS.merge+' Fusion manuelle</button></div>';
  }
  var byGeh={};
  m.prelevements.forEach(function(p){var k=p.gehId;if(!byGeh[k])byGeh[k]=[];byGeh[k].push(p);});
  m.gehs.filter(function(g){return g.name;}).forEach(function(g){
    var ps=byGeh[g.id]||[];
    var dc=0,tc=0;
    ps.forEach(function(p){p.subPrelevements.forEach(function(s){tc++;if(s.completed)dc++;});});
    var isOpen=state.expandedGeh[g.id];
    h+='<div class="accordion"><div class="accordion-header '+(isOpen?'open':'')+'" onclick="toggleGehAccordion('+g.id+');"><span class="accordion-icon">'+ICONS.chevronRight+'</span><span class="accordion-title">'+g.num+'. '+escapeHtml(g.name)+'</span><span class="accordion-count">'+dc+'/'+tc+'</span><button class="btn btn-danger btn-icon" style="width:24px;height:24px;margin-left:6px;font-size:11px;" onclick="event.stopPropagation();deleteGehTerrain('+g.id+');">'+ICONS.trash+'</button></div><div class="accordion-body '+(isOpen?'open':'')+'">';
    if(ps.length===0){
      h+='<div class="empty-state" style="padding:16px;color:#6b7280;"><p>Aucun prélèvement</p></div>';
    }else{
      ps.forEach(function(p){
        var anyDone=p.subPrelevements.some(function(s){return s.completed;});
        var allDone=p.subPrelevements.every(function(s){return s.completed;});
        var mc=p.agents&&p.agents[0]?p.agents[0].color:'#3b82f6';
        var isSelected=state.selectedForFusion.indexOf(p.id)!==-1;
        var agentNames=p.agents&&p.agents.length>0?p.agents.map(function(a){return escapeHtml(a.name);}).join(' + '):'Agent inconnu';
        h+='<div class="prel-item '+(isSelected?'selected':'')+'" style="background:'+lightenColor(mc,0.85)+';">';
        if(state.fusionMode){
          h+='<div class="prel-checkbox '+(isSelected?'checked':'')+'" onclick="toggleFusionSelect('+p.id+');">✓</div>';
        }else{
          h+='<div class="prel-status '+(allDone?'done':'pending')+'" onclick="openPrel('+p.id+');">✓</div>';
        }
        h+='<div class="prel-content" onclick="'+(state.fusionMode?'toggleFusionSelect('+p.id+');':'openPrel('+p.id+');')+'"><div class="prel-title" style="color:'+mc+';">'+agentNames+'</div><div class="prel-subtitle">'+p.type+' • '+p.subPrelevements.length+' sous-prél. '+(p.isReglementaire?'<span class="prel-reg-badge">Régl.</span>':'<span class="prel-nonreg-badge">Non-régl.</span>')+'</div></div>';
        if(!state.fusionMode){
          h+='<button class="btn btn-danger btn-icon" style="width:24px;height:24px;font-size:11px;margin-right:2px;" onclick="event.stopPropagation();deletePrelTerrain('+p.id+');">'+ICONS.trash+'</button>';
        }
        h+='<div class="prel-arrow" onclick="'+(state.fusionMode?'toggleFusionSelect('+p.id+');':'openPrel('+p.id+');')+'">'+ICONS.arrowRight+'</div></div>';
      });
    }
    h+='</div></div>';
  });
  
  // Modals
  if(state.showModal==='addGehTerrain')h+=renderAddGehTerrainModal();
  if(state.showModal==='addPrelTerrain')h+=renderAddPrelTerrainModal();
  if(state.showModal==='smartFusion')h+=renderSmartFusionModal();
  if(state.showModal==='qrCode')h+=renderQRCodeModal();
  
  return h;
}

function toggleGehAccordion(gid){state.expandedGeh[gid]=!state.expandedGeh[gid];render();}

function deleteMissionTerrain(){
  var m=getCurrentMission();if(!m)return;
  if(!confirm('Supprimer la mission "'+m.clientSite+'" ?\n\nToutes les données seront perdues !'))return;
  state.missions=state.missions.filter(function(x){return x.id!==m.id;});
  saveData('vlep_missions_v3',state.missions);
  state.currentMissionId=null;
  state.view='terrain-list';
  render();
}

// ===== AJOUT/SUPPRESSION TERRAIN =====
function renderAddGehTerrainModal(){
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>+ Ajouter un GEH</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div>';
  h+='<div class="field"><label class="label">Nom du GEH *</label><input type="text" class="input" id="new-geh-name" placeholder="Ex: Atelier peinture"></div>';
  h+='<div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-primary" onclick="addGehTerrain();">Ajouter</button></div></div></div>';
  return h;
}

function addGehTerrain(){
  var input=document.getElementById('new-geh-name');
  var name=input?input.value.trim():'';
  if(!name){alert('Saisissez un nom de GEH');return;}
  var m=getCurrentMission();if(!m)return;
  var newNum=m.gehs.length+1;
  var newGeh={id:generateId(),num:newNum,name:name};
  m.gehs.push(newGeh);
  state.expandedGeh[newGeh.id]=true;
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  render();
}

function deleteGehTerrain(gehId){
  var m=getCurrentMission();if(!m)return;
  var geh=m.gehs.find(function(g){return g.id===gehId;});
  var prelCount=m.prelevements.filter(function(p){return p.gehId===gehId;}).length;
  var msg='Supprimer le GEH "'+geh.name+'" ?';
  if(prelCount>0)msg+='\n\n'+prelCount+' prélèvement(s) seront également supprimés !';
  if(!confirm(msg))return;
  // Supprimer les prélèvements associés
  m.prelevements=m.prelevements.filter(function(p){return p.gehId!==gehId;});
  // Supprimer le GEH
  m.gehs=m.gehs.filter(function(g){return g.id!==gehId;});
  // Renuméroter
  m.gehs.forEach(function(g,i){g.num=i+1;});
  saveData('vlep_missions_v3',state.missions);
  render();
}

function deletePrelTerrain(prelId){
  var m=getCurrentMission();if(!m)return;
  var prel=m.prelevements.find(function(p){return p.id===prelId;});
  if(!prel)return;
  var agentNames=prel.agents.map(function(a){return a.name;}).join(' + ');
  if(!confirm('Supprimer le prélèvement "'+agentNames+'" ('+prel.type+') ?'))return;
  m.prelevements=m.prelevements.filter(function(p){return p.id!==prelId;});
  updateMissionStatus(m);
  saveData('vlep_missions_v3',state.missions);
  render();
}

function renderAddPrelTerrainModal(){
  var m=getCurrentMission();
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;state.newPrelData=null;render();}"><div class="modal-content" style="max-height:90vh;"><div class="modal-header"><h2>+ Ajouter un prélèvement</h2><button class="close-btn" onclick="state.showModal=null;state.newPrelData=null;render();">×</button></div>';
  
  if(!state.newPrelData){
    state.newPrelData={gehId:null,agents:[],type:'8h',isReg:true,agentSearch:''};
  }
  var d=state.newPrelData;
  
  // Sélection GEH
  h+='<div class="field"><label class="label">GEH *</label><select class="input" onchange="state.newPrelData.gehId=this.value;render();">';
  h+='<option value="">-- Sélectionner --</option>';
  m.gehs.filter(function(g){return g.name;}).forEach(function(g){
    h+='<option value="'+g.id+'" '+(d.gehId==g.id?'selected':'')+'>'+g.num+'. '+escapeHtml(g.name)+'</option>';
  });
  h+='</select></div>';
  
  // Type
  h+='<div class="field"><label class="label">Type de VLEP *</label><div class="row">';
  h+='<button class="btn btn-small '+(d.type==='8h'?'btn-primary':'btn-gray')+'" onclick="state.newPrelData.type=\'8h\';render();">8h</button>';
  h+='<button class="btn btn-small '+(d.type==='CT'?'btn-primary':'btn-gray')+'" onclick="state.newPrelData.type=\'CT\';render();">CT</button>';
  h+='</div></div>';
  
  // Réglementaire
  h+='<div class="field"><label class="label">Statut</label><div class="row">';
  h+='<button class="btn btn-small '+(d.isReg?'btn-success':'btn-gray')+'" onclick="state.newPrelData.isReg=true;render();">Réglementaire</button>';
  h+='<button class="btn btn-small '+(!d.isReg?'btn-orange':'btn-gray')+'" onclick="state.newPrelData.isReg=false;render();">Non-réglementaire</button>';
  h+='</div></div>';
  
  // Agents
  h+='<div class="field"><label class="label">Agent(s) chimique(s) *</label>';
  h+='<input type="text" class="input" id="new-prel-agent-search" placeholder="Rechercher..." value="'+escapeHtml(d.agentSearch||'')+'" oninput="handleNewPrelAgentSearch(this.value);"></div>';
  h+='<div id="new-prel-search-results">';
  if(d.agentSearch&&d.agentSearch.length>=2){
    var results=searchAgentsDB(d.agentSearch);
    var filtered=results.filter(function(x){return!d.agents.some(function(a){return a.name===x;});});
    if(filtered.length>0){
      h+='<div class="search-results" style="max-height:120px;overflow-y:auto;">';
      filtered.slice(0,6).forEach(function(x){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addNewPrelAgent(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  h+='</div>';
  
  if(d.agents.length>0){
    h+='<div class="info-box mt-8"><strong>Agents sélectionnés :</strong><div style="margin-top:4px;">';
    d.agents.forEach(function(a,i){
      h+='<span style="display:inline-block;background:#e5e7eb;padding:2px 8px;border-radius:4px;margin:2px;font-size:12px;">'+escapeHtml(a.name)+' <span style="cursor:pointer;color:#ef4444;" onclick="removeNewPrelAgent('+i+');">×</span></span>';
    });
    h+='</div></div>';
  }
  
  // Nombre de sous-prélèvements
  var subCount=d.isReg&&d.type==='8h'?3:1;
  h+='<div class="info-box info-box-success mt-12"><p>'+subCount+' sous-prélèvement(s) seront créés</p></div>';
  
  var canAdd=d.gehId&&d.agents.length>0;
  h+='<div class="row mt-12"><button class="btn btn-gray" onclick="state.showModal=null;state.newPrelData=null;render();">Annuler</button><button class="btn btn-primary" '+(canAdd?'':'disabled')+' onclick="addPrelTerrain();">Ajouter</button></div></div></div>';
  return h;
}

function renderSmartFusionModal(){
  if(!state.fusionGroups||state.fusionGroups.length===0)return'';
  
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;state.fusionGroups=null;render();}"><div class="modal-content" style="max-height:90vh;overflow-y:auto;"><div class="modal-header"><h2>'+ICONS.zap+' Fusion intelligente</h2><button class="close-btn" onclick="state.showModal=null;state.fusionGroups=null;render();">×</button></div>';
  
  var selectedCount=state.fusionGroups.filter(function(g){return g.selected;}).length;
  
  h+='<div class="info-box mb-12"><p><strong>'+state.fusionGroups.length+' groupe(s) fusionnable(s) détecté(s)</strong></p><p style="font-size:11px;margin-top:4px;">Décochez les groupes que vous ne souhaitez pas fusionner</p></div>';
  
  // Boutons rapides
  h+='<div class="row mb-12"><button class="btn btn-gray btn-small" onclick="toggleAllGroups(true);">Tout sélectionner</button><button class="btn btn-gray btn-small" onclick="toggleAllGroups(false);">Tout désélectionner</button></div>';
  
  // Liste des groupes
  state.fusionGroups.forEach(function(group){
    var hasWarnings=group.warnings.length>0;
    h+='<div class="card" style="padding:10px;margin-bottom:8px;border-left:4px solid '+(hasWarnings?'var(--warning)':'var(--accent)')+';">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">';
    h+='<input type="checkbox" '+(group.selected?'checked':'')+' onchange="toggleGroupSelection(\''+group.id+'\');" style="width:18px;height:18px;cursor:pointer;">';
    h+='<div style="flex:1;"><div style="font-weight:700;font-size:13px;color:var(--text-dark);">'+group.gehNum+'. '+escapeHtml(group.gehName)+'</div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">'+group.type+' • '+(group.isReglementaire?'Réglementaire':'Non-régl.')+'</div></div>';
    h+='<div style="background:var(--primary-pale);color:var(--primary);padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700;">'+group.prelevements.length+' prél.</div>';
    h+='</div>';
    
    // Agents
    h+='<div style="font-size:12px;color:var(--text-dark);margin-bottom:4px;"><strong>Agents:</strong> '+group.agentNames.map(escapeHtml).join(', ')+'</div>';
    
    // Avertissements
    if(hasWarnings){
      h+='<div style="background:#fef3c7;border-radius:6px;padding:6px 8px;font-size:11px;color:#b45309;"><strong>⚠️ Attention:</strong> '+group.warnings.join(', ')+'</div>';
    }
    
    h+='</div>';
  });
  
  h+='<div class="row mt-12"><button class="btn btn-gray" onclick="state.showModal=null;state.fusionGroups=null;render();">Annuler</button><button class="btn btn-success" onclick="doSmartFusion();" '+(selectedCount===0?'disabled':'')+'>Fusionner ('+selectedCount+')</button></div>';
  h+='</div></div>';
  return h;
}

function handleNewPrelAgentSearch(value){
  state.newPrelData.agentSearch=value;
  var container=document.getElementById('new-prel-search-results');
  if(!container)return;
  var d=state.newPrelData;
  var h='';
  if(value&&value.length>=2){
    var results=searchAgentsDB(value);
    var filtered=results.filter(function(x){return!d.agents.some(function(a){return a.name===x;});});
    if(filtered.length>0){
      h+='<div class="search-results" style="max-height:120px;overflow-y:auto;">';
      filtered.slice(0,6).forEach(function(x){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addNewPrelAgent(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  container.innerHTML=h;
}

function addNewPrelAgent(name){
  if(!state.newPrelData)return;
  if(state.newPrelData.agents.some(function(a){return a.name===name;}))return;
  var color=AGENT_COLORS[state.newPrelData.agents.length%AGENT_COLORS.length];
  state.newPrelData.agents.push({name:name,color:color});
  state.newPrelData.agentSearch='';
  render();
}

function removeNewPrelAgent(i){
  if(!state.newPrelData)return;
  state.newPrelData.agents.splice(i,1);
  render();
}

function addPrelTerrain(){
  var m=getCurrentMission();if(!m)return;
  var d=state.newPrelData;
  if(!d||!d.gehId||d.agents.length===0)return;
  
  var geh=m.gehs.find(function(g){return String(g.id)===String(d.gehId);});
  if(!geh)return;
  
  var subCount=d.isReg&&d.type==='8h'?3:1;
  var newPrel={
    id:generateId(),
    gehId:geh.id,
    gehName:geh.name,
    gehNum:geh.num,
    agents:d.agents.slice(),
    type:d.type,
    isReglementaire:d.isReg,
    subPrelevements:[]
  };
  
  for(var i=0;i<subCount;i++){
    var sub={id:generateId(),operateur:'',date:'',plages:[{debut:'',fin:''}],observations:'',completed:false,agentData:{}};
    d.agents.forEach(function(a){
      sub.agentData[a.name]={refEchantillon:'',numPompe:'',debitInitial:'',debitFinal:''};
    });
    newPrel.subPrelevements.push(sub);
  }
  
  m.prelevements.push(newPrel);
  state.expandedGeh[geh.id]=true;
  updateMissionStatus(m);
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  state.newPrelData=null;
  render();
}

function startFusionMode(){
  state.fusionMode=true;
  state.selectedForFusion=[];
  var m=getCurrentMission();
  if(m)m.gehs.forEach(function(g){state.expandedGeh[g.id]=true;});
  render();
}

function cancelFusion(){state.fusionMode=false;state.selectedForFusion=[];render();}

function toggleFusionSelect(pid){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(!p)return;
  var i=state.selectedForFusion.indexOf(pid);
  if(i===-1){
    if(state.selectedForFusion.length>0){
      var fp=m.prelevements.find(function(x){return x.id===state.selectedForFusion[0];});
      if(fp.gehId!==p.gehId||fp.type!==p.type||fp.isReglementaire!==p.isReglementaire){
        alert('Les prélèvements doivent être du même GEH, même type et même statut réglementaire');
        return;
      }
    }
    state.selectedForFusion.push(pid);
  }else state.selectedForFusion.splice(i,1);
  render();
}

function doFusion(){
  var m=getCurrentMission();
  if(!m||state.selectedForFusion.length<2)return;
  var tm=m.prelevements.filter(function(p){return state.selectedForFusion.indexOf(p.id)!==-1;});
  if(tm.length<2)return;
  var first=tm[0];
  var errors=[];
  for(var j=1;j<tm.length;j++){
    var o=tm[j];
    if(o.gehId!==first.gehId)errors.push('GEH différent');
    if(o.type!==first.type)errors.push('Type différent (8h/CT)');
    if(o.isReglementaire!==first.isReglementaire)errors.push('Statut réglementaire différent');
  }
  if(errors.length>0){alert('Fusion impossible:\n- '+errors.join('\n- '));return;}
  var mn=tm[0];
  for(var j=1;j<tm.length;j++){
    var o=tm[j];
    o.agents.forEach(function(a){if(!mn.agents.some(function(x){return x.name===a.name;}))mn.agents.push(a);});
    for(var s=0;s<mn.subPrelevements.length&&s<o.subPrelevements.length;s++){
      if(!mn.subPrelevements[s].agentData)mn.subPrelevements[s].agentData={};
      if(o.subPrelevements[s].agentData){
        for(var an in o.subPrelevements[s].agentData){
          if(!mn.subPrelevements[s].agentData[an])mn.subPrelevements[s].agentData[an]=o.subPrelevements[s].agentData[an];
        }
      }
    }
    var idx=m.prelevements.findIndex(function(x){return x.id===o.id;});
    if(idx!==-1)m.prelevements.splice(idx,1);
  }
  saveData('vlep_missions_v3',state.missions);
  state.fusionMode=false;
  state.selectedForFusion=[];
  render();
}

// Nouvelle fonction : Analyse les groupes fusionnables
function analyzeGroupsForFusion(){
  var m=getCurrentMission();
  if(!m)return[];
  
  var groups=[];
  var processed={};
  
  m.prelevements.forEach(function(p){
    if(processed[p.id])return;
    
    // Trouver tous les prélèvements compatibles
    var compatible=m.prelevements.filter(function(x){
      return x.gehId===p.gehId && x.type===p.type && x.isReglementaire===p.isReglementaire && x.id!==p.id && !processed[x.id];
    });
    
    if(compatible.length>0){
      var allInGroup=[p].concat(compatible);
      var gehInfo=m.gehs.find(function(g){return g.id===p.gehId;});
      var agentNames=[];
      allInGroup.forEach(function(pr){
        pr.agents.forEach(function(a){
          if(agentNames.indexOf(a.name)===-1)agentNames.push(a.name);
        });
      });
      
      // Vérifier les différences
      var warnings=[];
      var operators={};
      var dates={};
      var supports={};
      var codesPretrait={};
      
      allInGroup.forEach(function(pr){
        pr.subPrelevements.forEach(function(sub){
          if(sub.operateur)operators[sub.operateur]=true;
          if(sub.date)dates[sub.date]=true;
        });
        pr.agents.forEach(function(a){
          var ag=getAgentFromDB(a.name);
          if(ag){
            var sup=ag['Support de prélèvement']||'';
            var cp=ag['Code prétraitement']||'';
            if(sup)supports[sup]=true;
            if(cp)codesPretrait[cp]=true;
          }
        });
      });
      var opCount=Object.keys(operators).length;
      var dateCount=Object.keys(dates).length;
      if(opCount>1)warnings.push('Opérateurs différents');
      if(dateCount>1)warnings.push('Dates différentes');
      if(Object.keys(supports).length>1)warnings.push('Supports différents: '+Object.keys(supports).join(', '));
      if(Object.keys(codesPretrait).length>1)warnings.push('Codes prétraitement différents: '+Object.keys(codesPretrait).join(', '));
      
      groups.push({
        id:'group_'+p.id,
        gehId:p.gehId,
        gehName:gehInfo?gehInfo.name:'',
        gehNum:gehInfo?gehInfo.num:'',
        type:p.type,
        isReglementaire:p.isReglementaire,
        prelevements:allInGroup,
        agentNames:agentNames,
        warnings:warnings,
        selected:warnings.length===0 // Auto-sélectionner seulement si pas de warnings
      });
      
      allInGroup.forEach(function(pr){processed[pr.id]=true;});
    }
  });
  
  return groups;
}

// Nouvelle fonction : Affiche le modal de fusion intelligente
function showSmartFusionModal(){
  var groups=analyzeGroupsForFusion();
  if(groups.length===0){
    alert('Aucun prélèvement fusionnable trouvé.\n\nLes prélèvements doivent partager :\n- Même GEH\n- Même type (8h ou CT)\n- Même statut réglementaire');
    return;
  }
  state.showModal='smartFusion';
  state.fusionGroups=groups;
  render();
}

// Nouvelle fonction : Effectue la fusion intelligente
function doSmartFusion(){
  var m=getCurrentMission();
  if(!m||!state.fusionGroups)return;
  
  var selectedGroups=state.fusionGroups.filter(function(g){return g.selected;});
  if(selectedGroups.length===0){
    alert('Aucun groupe sélectionné');
    return;
  }
  
  var totalFused=0;
  selectedGroups.forEach(function(group){
    if(group.prelevements.length<2)return;
    
    var first=group.prelevements[0];
    for(var j=1;j<group.prelevements.length;j++){
      var other=group.prelevements[j];
      
      // Fusionner les agents
      other.agents.forEach(function(a){
        if(!first.agents.some(function(x){return x.name===a.name;})){
          first.agents.push(a);
        }
      });
      
      // Fusionner les données de sous-prélèvements
      for(var s=0;s<first.subPrelevements.length&&s<other.subPrelevements.length;s++){
        if(!first.subPrelevements[s].agentData)first.subPrelevements[s].agentData={};
        if(other.subPrelevements[s].agentData){
          for(var an in other.subPrelevements[s].agentData){
            if(!first.subPrelevements[s].agentData[an]){
              first.subPrelevements[s].agentData[an]=other.subPrelevements[s].agentData[an];
            }
          }
        }
      }
      
      // Supprimer l'autre prélèvement
      var idx=m.prelevements.findIndex(function(x){return x.id===other.id;});
      if(idx!==-1){
        m.prelevements.splice(idx,1);
        totalFused++;
      }
    }
  });
  
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  state.fusionGroups=null;
  render();
  
  alert('Fusion réussie !\n\n'+selectedGroups.length+' groupe(s) fusionné(s)\n'+totalFused+' prélèvement(s) fusionné(s)');
}

// Nouvelle fonction : Toggle sélection groupe
function toggleGroupSelection(groupId){
  if(!state.fusionGroups)return;
  var group=state.fusionGroups.find(function(g){return g.id===groupId;});
  if(group)group.selected=!group.selected;
  render();
}

// Nouvelle fonction : Tout sélectionner/désélectionner
function toggleAllGroups(select){
  if(!state.fusionGroups)return;
  state.fusionGroups.forEach(function(g){g.selected=select;});
  render();
}

function openPrel(pid){
  if(state.fusionMode)return;
  state.currentPrelId=pid;
  state.activeSubIndex=0;
  state.view='terrain-prel';
  render();
}

function calcDebitVariation(di,df){
  if(!di||!df||isNaN(parseFloat(di))||isNaN(parseFloat(df)))return null;
  var dI=parseFloat(di);
  var dF=parseFloat(df);
  if(dI<=0)return null;
  return Math.abs(dF-dI)/dI*100;
}

function renderTerrainPrel(){
  var m=getCurrentMission();
  if(!m){state.view='terrain-list';render();return'';}
  var p=m.prelevements.find(function(x){return x.id===state.currentPrelId;});
  if(!p){state.view='terrain-mission';render();return'';}
  var mc=p.agents&&p.agents[0]?p.agents[0].color:'#3b82f6';
  var agentNames=p.agents&&p.agents.length>0?p.agents.map(function(a){return escapeHtml(a.name||'???');}).join(' + '):'Agent inconnu';
  var h='<div class="sticky-header"><button class="back-btn" onclick="state.view=\'terrain-mission\';state.currentPrelId=null;render();">'+ICONS.arrowLeft+' Liste</button><div style="color:white;font-size:12px;opacity:0.85;">'+agentNames+' - '+p.type+' | GEH '+p.gehNum+'</div></div><div class="card" style="border-left:4px solid '+mc+';"><h2 style="color:'+mc+';">'+agentNames+' - '+p.type+'</h2><p class="subtitle"><span class="svg-icon">'+ICONS.folder+'</span> GEH '+p.gehNum+' - '+escapeHtml(p.gehName)+' | '+(p.isReglementaire?'Réglementaire':'Non-régl.')+'</p></div>';
  if(p.subPrelevements.length>1){
    h+='<div class="tabs">';
    for(var t=0;t<p.subPrelevements.length;t++){
      var sb=p.subPrelevements[t];
      h+='<button class="tab '+(state.activeSubIndex===t?'active':'')+'" onclick="state.activeSubIndex='+t+';render();">Prél '+(t+1)+(sb.completed?' ✓':'')+'</button>';
    }
    h+='</div>';
  }
  h+=renderSubPrelForm(p,p.subPrelevements[state.activeSubIndex],state.activeSubIndex);
  return h;
}

// FIX #4 & #5: Ajout des boutons "Copier J-1" et auto-date
function renderSubPrelForm(p,sb,idx){
  var m=getCurrentMission();
  var canCopyFromPrevious=idx>0;
  
  var h='<div class="card">';
  
  // Opérateur avec bouton copier J-1
  h+='<div class="field"><div class="field-header"><label class="label">Opérateur / Point fixe</label>';
  if(canCopyFromPrevious)h+='<button class="copy-btn" onclick="copyFromPrevious('+p.id+','+idx+',\'operateur\');">'+ICONS.list+' J-1</button>';
  h+='</div><input type="text" class="input" value="'+escapeHtml(sb.operateur||'')+'" onchange="updateSubFieldWithAutoDate('+p.id+','+idx+',\'operateur\',this.value);"></div>';
  
  // Date
  h+='<div class="field"><label class="label">Date</label><input type="date" class="input" value="'+(sb.date||'')+'" onchange="updateSubField('+p.id+','+idx+',\'date\',this.value);"></div>';
  
  h+='<div class="field"><label class="label"><span class="svg-icon">'+ICONS.beaker+'</span> Agent(s) chimique(s)</label>';
  
  if(!p.agents||p.agents.length===0){
    h+='<div class="info-box info-box-warning"><p>Aucun agent chimique défini pour ce prélèvement</p></div>';
  }else{
    p.agents.forEach(function(a){
      if(!sb.agentData)sb.agentData={};
      var aname=a.name||'Agent inconnu';
      if(!sb.agentData[aname])sb.agentData[aname]={refEchantillon:'',numPompe:'',debitInitial:'',debitFinal:''};
      var ad=sb.agentData[aname];
      var variation=calcDebitVariation(ad.debitInitial,ad.debitFinal);
      var hasWarning=variation!==null&&variation>5;
      
      h+='<div class="multi-agent-item"><div class="multi-agent-header"><div class="multi-agent-color" style="background:'+(a.color||'#3b82f6')+';"></div><div class="multi-agent-name">'+escapeHtml(aname)+'</div></div><div class="multi-agent-fields">';
      
      // N° Pompe avec bouton copier J-1
      h+='<div class="multi-agent-row"><label>N° Pompe';
      if(canCopyFromPrevious)h+='<button class="copy-btn" onclick="copyAgentDataFromPrevious('+p.id+','+idx+',\''+escapeJs(aname)+'\',\'numPompe\');">J-1</button>';
      h+='</label><input type="text" inputmode="numeric" value="'+escapeHtml(ad.numPompe||'')+'" placeholder="Ex: 123" onchange="updateAgentDataWithAutoDate('+p.id+','+idx+',\''+escapeJs(aname)+'\',\'numPompe\',this.value);"></div>';
      
      h+='<div class="multi-agent-row"><label>Débit initial</label><input type="text" inputmode="decimal" class="debit-input '+(hasWarning?'warning':'')+'" value="'+escapeHtml(ad.debitInitial||'')+'" placeholder="L/min" oninput="handleDebitInput(this);" onchange="updateAgentDataWithAutoDate('+p.id+','+idx+',\''+escapeJs(aname)+'\',\'debitInitial\',this.value);renderDebitVariation('+p.id+','+idx+',\''+escapeJs(aname)+'\');"></div>';
      h+='<div class="multi-agent-row"><label>Débit final</label><input type="text" inputmode="decimal" class="debit-input '+(hasWarning?'warning':'')+'" value="'+escapeHtml(ad.debitFinal||'')+'" placeholder="L/min" oninput="handleDebitInput(this);" onchange="updateAgentDataWithAutoDate('+p.id+','+idx+',\''+escapeJs(aname)+'\',\'debitFinal\',this.value);renderDebitVariation('+p.id+','+idx+',\''+escapeJs(aname)+'\');">';
      if(variation!==null){h+='<span class="debit-variation '+(hasWarning?'warning':'')+'">Δ '+variation.toFixed(1)+'%</span>';}
      h+='</div>';
      
      h+='<div class="multi-agent-row"><label>Réf. échant.</label><input type="text" value="'+escapeHtml(ad.refEchantillon||'')+'" placeholder="Référence..." onchange="updateAgentDataWithAutoDate('+p.id+','+idx+',\''+escapeJs(aname)+'\',\'refEchantillon\',this.value);"></div>';
      h+='</div></div>';
    });
  }
  h+='</div>';
  
  // Timer CT
  if(p.type==='CT'){
    var timerRunning=isTimerRunning(p.id,idx);
    if(timerRunning){
      h+=getTimerDisplay(p.id,idx);
    }else{
      h+='<button class="btn btn-primary" style="width:100%;margin:8px 0;" onclick="startCTTimer('+p.id+','+idx+');">▶️ Démarrer chrono CT</button>';
    }
  }
  
  h+='<div class="field"><label class="label">Plages horaires</label>';
  var pl=sb.plages||[{debut:'',fin:''}];
  pl.forEach(function(x,pi){
    h+='<div class="plage-row"><div class="plage-num">'+(pi+1)+'</div><input type="time" class="plage-input" value="'+(x.debut||'')+'" onchange="updatePlageWithAutoDate('+p.id+','+idx+','+pi+',\'debut\',this.value);"><span class="plage-sep">'+ICONS.arrowRight+'</span><input type="time" class="plage-input" value="'+(x.fin||'')+'" onchange="updatePlageWithAutoDate('+p.id+','+idx+','+pi+',\'fin\',this.value);">';
    if(pl.length>1)h+='<button class="plage-delete" onclick="removePlage('+p.id+','+idx+','+pi+');">✕</button>';
    h+='</div>';
  });
  if(pl.length<10)h+='<button class="btn btn-gray btn-small" onclick="addPlage('+p.id+','+idx+');">+ Plage</button>';
  h+='</div>';
  
  var d=getDureeTotale(pl);
  if(d)h+='<div class="duration-box"><span style="display:inline-flex;width:16px;height:16px;">'+ICONS.clock+'</span> Durée : '+d+'</div>';
  
  h+='<div class="field"><label class="label">Observations</label><div style="display:flex;gap:6px;align-items:flex-start;"><textarea class="input" style="flex:1;" rows="2" id="obs-'+p.id+'-'+idx+'" onchange="updateSubFieldWithAutoDate('+p.id+','+idx+',\'observations\',this.value);">'+escapeHtml(sb.observations||'')+'</textarea><button class="dictation-btn" id="dict-btn-'+p.id+'-'+idx+'" onclick="toggleDictation('+p.id+','+idx+');" title="Dictée vocale">'+ICONS.mic+'</button></div></div>';
  h+='<button class="btn btn-success" onclick="toggleSubComplete('+p.id+','+idx+');">'+(sb.completed?'✓ Complété - Modifier':'✓ Valider')+'</button></div>';
  return h;
}

// FIX #4: Fonctions pour copier depuis J-1
function copyFromPrevious(pid,idx,field){
  if(idx<=0)return;
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(!p)return;
  var prevSub=p.subPrelevements[idx-1];
  var currentSub=p.subPrelevements[idx];
  if(prevSub&&prevSub[field]){
    currentSub[field]=prevSub[field];
    saveData('vlep_missions_v3',state.missions);
    render();
  }
}

function copyAgentDataFromPrevious(pid,idx,agentName,field){
  if(idx<=0)return;
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(!p)return;
  var prevSub=p.subPrelevements[idx-1];
  var currentSub=p.subPrelevements[idx];
  if(prevSub&&prevSub.agentData&&prevSub.agentData[agentName]&&prevSub.agentData[agentName][field]){
    if(!currentSub.agentData)currentSub.agentData={};
    if(!currentSub.agentData[agentName])currentSub.agentData[agentName]={};
    currentSub.agentData[agentName][field]=prevSub.agentData[agentName][field];
    saveData('vlep_missions_v3',state.missions);
    render();
  }
}

// FIX #5: Fonctions avec auto-date
function getTodayDate(){
  var d=new Date();
  return d.toISOString().split('T')[0];
}

function autoFillDate(p,idx){
  var sb=p.subPrelevements[idx];
  if(!sb.date){
    sb.date=getTodayDate();
  }
}

function updateSubFieldWithAutoDate(pid,idx,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){
    p.subPrelevements[idx][f]=v;
    autoFillDate(p,idx);
    saveData('vlep_missions_v3',state.missions);
  }
}

function updateAgentDataWithAutoDate(pid,idx,an,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){
    if(!p.subPrelevements[idx].agentData)p.subPrelevements[idx].agentData={};
    if(!p.subPrelevements[idx].agentData[an])p.subPrelevements[idx].agentData[an]={};
    p.subPrelevements[idx].agentData[an][f]=v;
    autoFillDate(p,idx);
    saveData('vlep_missions_v3',state.missions);
  }
}

function updatePlageWithAutoDate(pid,idx,pi,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){
    p.subPrelevements[idx].plages[pi][f]=v;
    autoFillDate(p,idx);
    saveData('vlep_missions_v3',state.missions);
    render();
  }
}

function handleDebitInput(input){
  var v=input.value;
  v=v.replace(/[^0-9.,]/g,'');
  v=v.replace(',','.');
  input.value=v;
}

function renderDebitVariation(pid,idx,aname){render();}

function updateSubField(pid,idx,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){p.subPrelevements[idx][f]=v;saveData('vlep_missions_v3',state.missions);}
}

function updateAgentData(pid,idx,an,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){
    if(!p.subPrelevements[idx].agentData)p.subPrelevements[idx].agentData={};
    if(!p.subPrelevements[idx].agentData[an])p.subPrelevements[idx].agentData[an]={};
    p.subPrelevements[idx].agentData[an][f]=v;
    saveData('vlep_missions_v3',state.missions);
  }
}

function updatePlage(pid,idx,pi,f,v){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){p.subPrelevements[idx].plages[pi][f]=v;saveData('vlep_missions_v3',state.missions);render();}
}

function addPlage(pid,idx){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p&&p.subPrelevements[idx].plages.length<10){
    p.subPrelevements[idx].plages.push({debut:'',fin:''});
    saveData('vlep_missions_v3',state.missions);
    render();
  }
}

function removePlage(pid,idx,pi){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p&&p.subPrelevements[idx].plages.length>1){
    p.subPrelevements[idx].plages.splice(pi,1);
    saveData('vlep_missions_v3',state.missions);
    render();
  }
}

function getDureeTotale(pl){
  var mn=0;
  pl.forEach(function(x){
    if(x.debut&&x.fin){
      var d=x.debut.split(':'),f=x.fin.split(':');
      var df=(parseInt(f[0])*60+parseInt(f[1]))-(parseInt(d[0])*60+parseInt(d[1]));
      if(df>0)mn+=df;
    }
  });
  if(mn<=0)return'';
  return Math.floor(mn/60)+'h'+(mn%60<10?'0':'')+(mn%60);
}

function toggleSubComplete(pid,idx){
  var m=getCurrentMission();if(!m)return;
  var p=m.prelevements.find(function(x){return x.id===pid;});
  if(p){
    p.subPrelevements[idx].completed=!p.subPrelevements[idx].completed;
    updateMissionStatus(m);
    saveData('vlep_missions_v3',state.missions);
    state.view='terrain-mission';
    render();
  }
}

function updateMissionStatus(m){
  var t=0,d=0;
  m.prelevements.forEach(function(p){p.subPrelevements.forEach(function(s){t++;if(s.completed)d++;});});
  if(d===0)m.status='validee';
  else if(d===t)m.status='terminee';
  else m.status='encours';
}

// FIX #7: Conditions ambiantes responsive mobile
function renderConditions(){
  var m=getCurrentMission();
  if(!m){state.view='terrain-mission';render();return'';}
  var h='<button class="back-btn" onclick="state.view=\'terrain-mission\';render();">'+ICONS.arrowLeft+' Mission</button><div class="card"><h2>'+ICONS.thermometer+' Conditions ambiantes</h2><p class="subtitle">Par jour de prélèvement</p><button class="btn btn-primary mt-12" onclick="addCondition();">+ Ajouter un jour</button></div>';
  if(!m.conditionsAmbiantes)m.conditionsAmbiantes=[];
  if(m.conditionsAmbiantes.length===0)h+='<div class="empty-state"><p>Aucune condition saisie</p></div>';
  else m.conditionsAmbiantes.forEach(function(c,i){
    h+='<div class="condition-card">';
    h+='<div class="condition-date"><input type="date" class="input" style="margin:0;flex:1;max-width:160px;" value="'+(c.date||'')+'" onchange="updateCond('+i+',\'date\',this.value);"><button class="btn btn-danger btn-icon" onclick="deleteCond('+i+');">'+ICONS.trash+'</button></div>';
    
    // Température
    h+='<div class="condition-row"><span class="condition-label">'+ICONS.thermometer+' Température (°C)</span><div class="condition-inputs"><div style="flex:1;"><div class="condition-input-label">Initial</div><input type="text" inputmode="decimal" class="condition-input condition-input-i" value="'+(c.tempI||'')+'" placeholder="I" onchange="updateCond('+i+',\'tempI\',this.value);"></div><div style="flex:1;"><div class="condition-input-label">Final</div><input type="text" inputmode="decimal" class="condition-input condition-input-f" value="'+(c.tempF||'')+'" placeholder="F" onchange="updateCond('+i+',\'tempF\',this.value);"></div></div></div>';
    
    // Pression
    h+='<div class="condition-row"><span class="condition-label">'+ICONS.database+' Pression (hPa)</span><div class="condition-inputs"><div style="flex:1;"><div class="condition-input-label">Initial</div><input type="text" inputmode="numeric" class="condition-input condition-input-i" value="'+(c.pressionI||'')+'" placeholder="I" onchange="updateCond('+i+',\'pressionI\',this.value);"></div><div style="flex:1;"><div class="condition-input-label">Final</div><input type="text" inputmode="numeric" class="condition-input condition-input-f" value="'+(c.pressionF||'')+'" placeholder="F" onchange="updateCond('+i+',\'pressionF\',this.value);"></div></div></div>';
    
    // Humidité
    h+='<div class="condition-row"><span class="condition-label">'+ICONS.droplet+' Humidité (%)</span><div class="condition-inputs"><div style="flex:1;"><div class="condition-input-label">Initial</div><input type="text" inputmode="numeric" class="condition-input condition-input-i" value="'+(c.humiditeI||'')+'" placeholder="I" onchange="updateCond('+i+',\'humiditeI\',this.value);"></div><div style="flex:1;"><div class="condition-input-label">Final</div><input type="text" inputmode="numeric" class="condition-input condition-input-f" value="'+(c.humiditeF||'')+'" placeholder="F" onchange="updateCond('+i+',\'humiditeF\',this.value);"></div></div></div>';
    
    h+='</div>';
  });
  return h;
}

function addCondition(){
  var m=getCurrentMission();if(!m)return;
  if(!m.conditionsAmbiantes)m.conditionsAmbiantes=[];
  m.conditionsAmbiantes.push({date:new Date().toISOString().split('T')[0],tempI:'',tempF:'',pressionI:'',pressionF:'',humiditeI:'',humiditeF:''});
  saveData('vlep_missions_v3',state.missions);
  render();
}

function updateCond(i,f,v){
  var m=getCurrentMission();
  if(m&&m.conditionsAmbiantes[i]){m.conditionsAmbiantes[i][f]=v;saveData('vlep_missions_v3',state.missions);}
}

function deleteCond(i){
  var m=getCurrentMission();
  if(m&&confirm('Supprimer ?')){m.conditionsAmbiantes.splice(i,1);saveData('vlep_missions_v3',state.missions);render();}
}

// FIX #1 & #2: Liste échantillons avec code analytique corrigé et regroupement
function renderListeEchantillons(){
  var m=getCurrentMission();
  if(!m){state.view='terrain-mission';render();return'';}
  if(!m.blancs)m.blancs=[];
  
  var h='<button class="back-btn" onclick="state.view=\'terrain-mission\';render();">'+ICONS.arrowLeft+' Mission</button><div class="card"><h2>'+ICONS.list+' Liste échantillons</h2><p class="subtitle">'+escapeHtml(m.clientSite)+'</p></div>';
  h+='<div class="row mb-12"><button class="btn btn-success" onclick="state.showModal=\'addBlanc\';state.blancAgentSearch=\'\';state.blancAgents=[];render();">+ Blanc terrain</button><button class="btn btn-primary" onclick="exportExcel();">'+ICONS.download+' Export Excel</button></div>';
  h+='<div class="row mb-12"><span style="font-size:13px;margin-right:8px;">Trier par :</span><button class="btn btn-small '+(state.echantillonSort==='date'?'btn-blue':'btn-gray')+'" onclick="state.echantillonSort=\'date\';render();">Date</button><button class="btn btn-small '+(state.echantillonSort==='agent'?'btn-blue':'btn-gray')+'" onclick="state.echantillonSort=\'agent\';render();">Agent</button></div>';
  
  // FIX #2: Regrouper par référence échantillon
  var byRef={};
  m.prelevements.forEach(function(p){
    p.subPrelevements.forEach(function(sb){
      p.agents.forEach(function(a){
        var d=sb.agentData?sb.agentData[a.name]:null;
        if(d&&d.refEchantillon){
          var ref=d.refEchantillon;
          if(!byRef[ref]){
            byRef[ref]={ref:ref,agents:[],date:sb.date||'',type:'Échantillon',isBlanc:false};
          }
          var ag=getAgentFromDB(a.name);
          byRef[ref].agents.push({name:a.name,code:getCodeAnalytique(ag)});
        }
      });
    });
  });
  
  // Blancs
  m.blancs.forEach(function(b){
    var ref=b.ref;
    if(!byRef[ref]){
      byRef[ref]={ref:ref,agents:[],date:b.date||'',type:'Blanc',isBlanc:true};
    }
    b.agents.forEach(function(an){
      var ag=getAgentFromDB(an);
      byRef[ref].agents.push({name:an,code:getCodeAnalytique(ag)});
    });
  });
  
  // Convertir en liste
  var l=Object.values(byRef);
  
  if(state.echantillonSort==='agent'){
    l.sort(function(a,b){
      var aName=a.agents[0]?a.agents[0].name:'';
      var bName=b.agents[0]?b.agents[0].name:'';
      return aName.localeCompare(bName);
    });
  }else{
    l.sort(function(a,b){return(a.date||'').localeCompare(b.date||'');});
  }
  
  if(l.length===0)h+='<div class="empty-state"><p>Aucun échantillon</p></div>';
  else{
    h+='<div class="card" style="padding:8px;overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;"><tr style="background:#f3f4f6;"><th style="padding:6px;text-align:left;">Réf.</th><th style="padding:6px;text-align:left;">Agent(s) chimique(s)</th><th style="padding:6px;">Date</th><th style="padding:6px;">Code(s) analytique(s)</th><th style="padding:6px;">Type</th></tr>';
    l.forEach(function(x){
      var bg=x.isBlanc?'background:#fef3c7;':'';
      var agentNames=x.agents.map(function(a){return a.name;}).join(', ');
      var codes=x.agents.map(function(a){return a.code;}).filter(function(c){return c;}).join(', ');
      h+='<tr style="border-bottom:1px solid #e5e7eb;'+bg+'"><td style="padding:6px;font-weight:600;">'+escapeHtml(x.ref)+'</td><td style="padding:6px;">'+escapeHtml(agentNames)+'</td><td style="padding:6px;text-align:center;">'+escapeHtml(x.date)+'</td><td style="padding:6px;text-align:center;">'+escapeHtml(codes||'-')+'</td><td style="padding:6px;text-align:center;"><span style="font-size:10px;padding:2px 6px;border-radius:4px;'+(x.isBlanc?'background:#f59e0b;color:white;':'background:#e5e7eb;')+'">'+x.type+'</span></td></tr>';
    });
    h+='</table></div>';
  }
  
  if(m.blancs.length>0){
    h+='<div class="section-title mt-12">Blancs terrain ('+m.blancs.length+')</div>';
    m.blancs.forEach(function(b,i){
      h+='<div class="card" style="padding:10px;background:#fef3c7;margin-bottom:8px;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><strong>'+escapeHtml(b.ref)+'</strong><div style="font-size:12px;color:#666;">'+escapeHtml(b.agents.join(', '))+' • '+escapeHtml(b.date||'Sans date')+'</div></div><button class="btn btn-danger btn-small" onclick="deleteBlanc('+i+');">'+ICONS.trash+'</button></div></div>';
    });
  }
  
  if(state.showModal==='addBlanc')h+=renderAddBlancModal();
  return h;
}

// FIX #3: Modal blanc avec recherche corrigée
function renderAddBlancModal(){
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>+ Blanc terrain</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div>';
  h+='<div class="field"><label class="label">Référence échantillon *</label><input type="text" class="input" id="blanc-ref" placeholder="Ex: BT-001" value="'+escapeHtml(state.blancRef||'')+'" oninput="state.blancRef=this.value;"></div>';
  h+='<div class="field"><label class="label">Date</label><input type="date" class="input" id="blanc-date" value="'+(state.blancDate||'')+'" oninput="state.blancDate=this.value;"></div>';
  h+='<div class="field"><label class="label">Agent(s) chimique(s)</label><input type="text" class="input" id="blanc-agent-search" placeholder="Rechercher..." value="'+escapeHtml(state.blancAgentSearch||'')+'" oninput="handleBlancAgentSearch(this.value);"></div>';
  h+='<div id="blanc-search-results">';
  if(state.blancAgentSearch&&state.blancAgentSearch.length>=2){
    var r=searchAgentsDB(state.blancAgentSearch).slice(0,6);
    if(r.length>0){
      h+='<div class="search-results" style="max-height:120px;overflow-y:auto;">';
      r.forEach(function(x){
        var already=state.blancAgents&&state.blancAgents.indexOf(x)!==-1;
        h+='<div class="search-result-item" style="'+(already?'opacity:0.5;':'')+'" onmousedown="event.preventDefault();" onclick="'+(already?'':'addBlancAgent(\''+escapeJs(x)+'\');')+'">'+escapeHtml(x)+(already?' ✓':'')+'</div>';
      });
      h+='</div>';
    }
  }
  h+='</div>';
  if(state.blancAgents&&state.blancAgents.length>0){
    h+='<div class="info-box mt-8"><strong>Agents sélectionnés :</strong><div style="margin-top:4px;">';
    state.blancAgents.forEach(function(a,i){
      h+='<span style="display:inline-block;background:#e5e7eb;padding:2px 8px;border-radius:4px;margin:2px;font-size:12px;">'+escapeHtml(a)+' <span style="cursor:pointer;color:#ef4444;" onclick="removeBlancAgent('+i+');">×</span></span>';
    });
    h+='</div></div>';
    // Avertissements si débits ou codes prétraitement différents
    var blancWarnings=checkBlancWarnings(state.blancAgents);
    if(blancWarnings.length>0){
      blancWarnings.forEach(function(w){
        h+='<div class="blanc-warning">'+escapeHtml(w)+'</div>';
      });
    }
  }
  h+='<div class="row mt-12"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-success" onclick="saveBlanc();">Ajouter</button></div></div></div>';
  return h;
}

// FIX #3: Handler de recherche blanc sans render() complet
function handleBlancAgentSearch(value){
  state.blancAgentSearch=value;
  updateBlancSearchResults();
}

function updateBlancSearchResults(){
  var container=document.getElementById('blanc-search-results');
  if(!container)return;
  var h='';
  if(state.blancAgentSearch&&state.blancAgentSearch.length>=2){
    var r=searchAgentsDB(state.blancAgentSearch).slice(0,6);
    if(r.length>0){
      h+='<div class="search-results" style="max-height:120px;overflow-y:auto;">';
      r.forEach(function(x){
        var already=state.blancAgents&&state.blancAgents.indexOf(x)!==-1;
        h+='<div class="search-result-item" style="'+(already?'opacity:0.5;':'')+'" onmousedown="event.preventDefault();" onclick="'+(already?'':'addBlancAgent(\''+escapeJs(x)+'\');')+'">'+escapeHtml(x)+(already?' ✓':'')+'</div>';
      });
      h+='</div>';
    }
  }
  container.innerHTML=h;
}

function addBlancAgent(name){
  if(!state.blancAgents)state.blancAgents=[];
  if(state.blancAgents.indexOf(name)===-1)state.blancAgents.push(name);
  state.blancAgentSearch='';
  render();
}

function removeBlancAgent(i){
  if(state.blancAgents)state.blancAgents.splice(i,1);
  render();
}

function checkBlancWarnings(agents){
  if(!agents||agents.length<=1)return[];
  var warnings=[];
  var debits={};
  var codesPretrait={};
  agents.forEach(function(an){
    var ag=getAgentFromDB(an);
    if(ag){
      var d8=ag['débit max  8h (L/min)']||ag['débit max 8h (L/min)']||'';
      var cp=ag['Code prétraitement']||'';
      if(d8)debits[d8]=(debits[d8]||[]).concat([an]);
      if(cp)codesPretrait[cp]=(codesPretrait[cp]||[]).concat([an]);
    }
  });
  if(Object.keys(debits).length>1){
    warnings.push('⚠️ Débits différents : '+Object.keys(debits).map(function(d){return d+' L/min ('+debits[d].join(', ')+')';}).join(' vs '));
  }
  if(Object.keys(codesPretrait).length>1){
    warnings.push('⚠️ Codes prétraitement différents : '+Object.keys(codesPretrait).map(function(c){return c+' ('+codesPretrait[c].join(', ')+')';}).join(' vs '));
  }
  return warnings;
}

function saveBlanc(){
  var ref=(state.blancRef||'').trim();
  var date=state.blancDate||'';
  if(!ref){alert('Saisissez une référence');return;}
  if(!state.blancAgents||state.blancAgents.length===0){alert('Sélectionnez au moins un agent');return;}
  var m=getCurrentMission();if(!m)return;
  if(!m.blancs)m.blancs=[];
  m.blancs.push({ref:ref,date:date,agents:state.blancAgents.slice()});
  saveData('vlep_missions_v3',state.missions);
  state.showModal=null;
  state.blancAgents=[];
  state.blancRef='';
  state.blancDate='';
  render();
}

function deleteBlanc(i){
  var m=getCurrentMission();
  if(!m||!confirm('Supprimer ce blanc ?'))return;
  m.blancs.splice(i,1);
  saveData('vlep_missions_v3',state.missions);
  render();
}

// ═══════════════════════════════════════════════════════════════════════════════
// EXPORT EXCEL - Structure cassette REG/NON REG COMPLÈTE
// © 2025 Quentin THOMAS
// Inclut : Conditions ambiantes, Débits I/F, Type 8h/CT, Blancs
// ═══════════════════════════════════════════════════════════════════════════════

function exportExcel(){
  var m=getCurrentMission();
  if(!m){alert('Aucune mission');return;}
  
  var wb=XLSX.utils.book_new();
  
  // Séparer les prélèvements REG et NON-REG
  var regPrels=[];
  var nonRegPrels=[];
  
  m.prelevements.forEach(function(p){
    p.subPrelevements.forEach(function(sb,si){
      p.agents.forEach(function(a){
        var prelData={
          prel:p,
          sub:sb,
          subIdx:si,
          agent:a.name,
          gehName:p.gehName,
          gehNum:p.gehNum,
          type:p.type,
          isReg:p.isReglementaire
        };
        
        if(p.isReglementaire){
          regPrels.push(prelData);
        }else{
          nonRegPrels.push(prelData);
        }
      });
    });
  });
  
  // Trier par GEH puis agent
  var sortByGehAgent=function(a,b){
    if(a.gehNum!==b.gehNum)return a.gehNum-b.gehNum;
    return a.agent.localeCompare(b.agent);
  };
  
  regPrels.sort(sortByGehAgent);
  nonRegPrels.sort(sortByGehAgent);
  
  // Créer la feuille REG
  if(regPrels.length>0){
    var wsReg=createRegSheet(m,regPrels);
    XLSX.utils.book_append_sheet(wb,wsReg,'REG');
  }
  
  // Créer la feuille NON REG
  if(nonRegPrels.length>0){
    var wsNonReg=createNonRegSheet(m,nonRegPrels);
    XLSX.utils.book_append_sheet(wb,wsNonReg,'NON REG');
  }
  
  // Créer la feuille Échantillons
  var wsEchantillons=createEchantillonsSheet(m,regPrels,nonRegPrels);
  XLSX.utils.book_append_sheet(wb,wsEchantillons,'Échantillons');
  
  // Créer la feuille Relevé d'activité
  var wsActivite=createActiviteSheet(m);
  XLSX.utils.book_append_sheet(wb,wsActivite,'Relevé activité');
  
  var fn=(m.clientSite||'Mission').replace(/[^a-zA-Z0-9àâäéèêëïîôùûüç\\s-]/g,'')+'_cassettes.xlsx';
  XLSX.writeFile(wb,fn);
  alert('Export terminé : '+fn);
}

function createRegSheet(m,prels){
  var aoa=[];
  
  // Lignes 1-3 : En-tête
  aoa.push(['Cassette Reg','CONTRÔLE REGLEMENTAIRE']);
  aoa.push(['22','PRELEVEMENTS SUR CASSETTE']);
  aoa.push([]);
  
  // Ligne 4-5 : Préleveur et site
  aoa.push(['nom du préleveur','',m.preleveur||'']);
  aoa.push(['site','',m.clientSite||'']);
  
  // Ligne 6 : GEH
  var row6=['GEH',''];
  for(var i=0;i<prels.length;i++){
    var p=prels[i];
    row6.push(p.gehNum+' - '+p.gehName);
    row6.push('');
  }
  aoa.push(row6);
  
  // Ligne 7 : opérateur
  var row7=['opérateur',''];
  for(var i=0;i<prels.length;i++){
    row7.push(prels[i].sub.operateur||'');
    row7.push('');
  }
  aoa.push(row7);
  
  // Ligne 8 : agent chimique
  var row8=['agent chimique',''];
  for(var i=0;i<prels.length;i++){
    row8.push(prels[i].agent);
    row8.push('');
  }
  aoa.push(row8);
  
  // Ligne 9 : Matériel de prélèvement
  aoa.push(['Matériel de mesure','']);
  
  // Lignes 10-11 : pompe + débitmètre
  var row10=['n° d\'identification','pompe'];
  var row11=['','Débimetre'];
  for(var i=0;i<prels.length;i++){
    var ad=prels[i].sub.agentData?prels[i].sub.agentData[prels[i].agent]:null;
    row10.push(ad&&ad.numPompe?ad.numPompe:'');
    row10.push('');
    row11.push(m.debitmetre||'');
    row11.push('');
  }
  aoa.push(row10);
  aoa.push(row11);
  
  // Ligne 12 : Support
  var row12=['Support','nature et marque'];
  for(var i=0;i<prels.length;i++){
    var ag=getAgentFromDB(prels[i].agent);
    var support=ag?(ag['Support de prélèvement']||''):'';
    row12.push(support);
    row12.push('');
  }
  aoa.push(row12);
  
  // Ligne 13 : Plages horaires
  aoa.push(['Plages horaires de prélèvement, durée du','']);
  
  // Ligne 14 : date
  var row14=['date de prélèvement',''];
  for(var i=0;i<prels.length;i++){
    row14.push(formatDateFR(prels[i].sub.date)||'');
    row14.push('');
  }
  aoa.push(row14);
  
  // Lignes 15-24 : 5 plages horaires (2 lignes chacune)
  for(var plageNum=1;plageNum<=5;plageNum++){
    var rowDebut=['plage n°'+plageNum,'heure début n°C'+plageNum+'-P'+plageNum+'_'];
    var rowFin=['','heure fin n°C'+plageNum+'-P'+plageNum+'_'];
    
    for(var i=0;i<prels.length;i++){
      var plages=prels[i].sub.plages||[];
      var plage=plages[plageNum-1];
      
      rowDebut.push(plage&&plage.debut?plage.debut:'');
      rowDebut.push('');
      rowFin.push(plage&&plage.fin?plage.fin:'');
      rowFin.push('');
    }
    
    aoa.push(rowDebut);
    aoa.push(rowFin);
  }
  
  // Ligne 25 : durée du prélèvement (vide)
  var row25=['durée du prélèvement (h)',''];
  for(var i=0;i<prels.length;i++){
    row25.push('');
    row25.push('');
  }
  aoa.push(row25);
  
  // Ligne 26 : durée d'exposition (vide)
  var row26=['durée d\'exposition (h:min) - VLEP 8h',''];
  for(var i=0;i<prels.length;i++){
    row26.push('');
    row26.push('');
  }
  aoa.push(row26);
  
  // Ligne 27 : durée d'exposition VLEP (vide)
  var row27=['durée d\'exposition - VLEP 8h',''];
  for(var i=0;i<prels.length;i++){
    row27.push('');
    row27.push('');
  }
  aoa.push(row27);
  
  // Ligne 28 : Prise en compte des EPI
  aoa.push(['Prise en compte des Equipements de Protection Individuelle','']);
  
  // Ligne 29 : type EPI (vide)
  var row29=['type d\'EPI',''];
  for(var i=0;i<prels.length;i++){
    row29.push('');
    row29.push('');
  }
  aoa.push(row29);
  
  // Ligne 30 : facteur de protection (vide)
  var row30=['facteur de protection assigné (FPA)',''];
  for(var i=0;i<prels.length;i++){
    row30.push('');
    row30.push('');
  }
  aoa.push(row30);
  
  // Ligne 31 : durée de port EPI (vide)
  var row31=['durée de port de l\'EPI (min)',''];
  for(var i=0;i<prels.length;i++){
    row31.push('');
    row31.push('');
  }
  aoa.push(row31);
  
  // Ligne 32 : Conditions ambiantes
  aoa.push(['Conditions ambiantes lors des prélèvements','']);
  
  // Lignes 33-35 : Température (initiale, finale, moyenne)
  var row33=['température ambiante (°C)','initiale'];
  var row34=['','finale'];
  var row35=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row33.push(cond&&cond.tempI?cond.tempI:'');
    row33.push('');
    row34.push(cond&&cond.tempF?cond.tempF:'');
    row34.push('');
    row35.push(''); // moyenne calculée après
    row35.push('');
  }
  aoa.push(row33);
  aoa.push(row34);
  aoa.push(row35);
  
  // Lignes 36-38 : Pression (initiale, finale, moyenne)
  var row36=['pression atmosphérique (hPa)','initiale'];
  var row37=['','finale'];
  var row38=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row36.push(cond&&cond.pressionI?cond.pressionI:'');
    row36.push('');
    row37.push(cond&&cond.pressionF?cond.pressionF:'');
    row37.push('');
    row38.push('');
    row38.push('');
  }
  aoa.push(row36);
  aoa.push(row37);
  aoa.push(row38);
  
  // Lignes 39-41 : Humidité (initiale, finale, moyenne)
  var row39=['humidité relative (%)','initiale'];
  var row40=['','finale'];
  var row41=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row39.push(cond&&cond.humiditeI?cond.humiditeI:'');
    row39.push('');
    row40.push(cond&&cond.humiditeF?cond.humiditeF:'');
    row40.push('');
    row41.push('');
    row41.push('');
  }
  aoa.push(row39);
  aoa.push(row40);
  aoa.push(row41);
  
  // Ligne 42 : Pression de saturation (vide)
  var row42=['pression de saturation de la vapeur d\'eau (Pa)',''];
  for(var i=0;i<prels.length;i++){
    row42.push('');
    row42.push('');
  }
  aoa.push(row42);
  
  // Ligne 43 : Volume prélevé
  aoa.push(['Volume prélevé','']);
  
  // Ligne 44 : Vérification débit
  aoa.push(['Volume prélevé avec pompe - Vérification du débit','']);
  
  // Lignes 45-46 : Débits initial et final
  var row45=['débit initial de la pompe (L/min) DM',''];
  var row46=['débit final de la pompe (L/min) DM',''];
  for(var i=0;i<prels.length;i++){
    var ad=prels[i].sub.agentData?prels[i].sub.agentData[prels[i].agent]:null;
    row45.push(ad&&ad.debitInitial?ad.debitInitial:'');
    row45.push('');
    row46.push(ad&&ad.debitFinal?ad.debitFinal:'');
    row46.push('');
  }
  aoa.push(row45);
  aoa.push(row46);
  
  // Lignes 47-48 : Débit moyen et volume (vides, calculés après)
  var row47=['débit moyen de la pompe (L/min)',''];
  var row48=['volume prélevé (L)',''];
  for(var i=0;i<prels.length;i++){
    row47.push('');
    row47.push('');
    row48.push('');
    row48.push('');
  }
  aoa.push(row47);
  aoa.push(row48);
  
  // Lignes 49-56 : Vérification DLS (vides)
  for(var lnum=49;lnum<=56;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 57 : Résultats labo
  aoa.push(['Résultats du laboratoire d\'analyse','']);
  
  // Lignes 58-62 : Nom labo, réf échantillon, masse, incertitude
  var row58=['nom du laboratoire',''];
  var row59=['référence de l\'échantillon',''];
  for(var i=0;i<prels.length;i++){
    row58.push('');
    row58.push('');
    var ad=prels[i].sub.agentData?prels[i].sub.agentData[prels[i].agent]:null;
    row59.push(ad&&ad.refEchantillon?ad.refEchantillon:'');
    row59.push('');
  }
  aoa.push(row58);
  aoa.push(row59);
  
  // Lignes 60-62 : masse et incertitude (vides)
  for(var lnum=60;lnum<=62;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 63 : RESULTATS
  aoa.push(['RESULTATS','']);
  
  // Lignes 64-69 : GEH, type VLEP, opérateur, agent, réf, date
  var row64=['GEH',''];
  var row65=['type de VLEP',''];
  var row66=['opérateur',''];
  var row67=['agent chimique',''];
  var row68=['référence de l\'échantillon',''];
  var row69=['date du prélèvement',''];
  
  for(var i=0;i<prels.length;i++){
    var p=prels[i];
    row64.push(p.gehNum+' - '+p.gehName);
    row64.push('');
    row65.push(p.type); // 8h ou CT
    row65.push('');
    row66.push(p.sub.operateur||'');
    row66.push('');
    row67.push(p.agent);
    row67.push('');
    var ad=p.sub.agentData?p.sub.agentData[p.agent]:null;
    row68.push(ad&&ad.refEchantillon?ad.refEchantillon:'');
    row68.push('');
    row69.push(formatDateFR(p.sub.date)||'');
    row69.push('');
  }
  aoa.push(row64);
  aoa.push(row65);
  aoa.push(row66);
  aoa.push(row67);
  aoa.push(row68);
  aoa.push(row69);
  
  // Lignes 70-78 : Durée, résultats, EPI, exposition, VLEP, commentaire (vides)
  for(var lnum=70;lnum<=78;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 79 : Validation des prélèvements
  aoa.push(['Validation des prélèvements','']);
  
  // Ligne 80 : Variation débit (vide)
  var row80=['Variation du débit avant et après prélèvement (< 5%)',''];
  for(var i=0;i<prels.length;i++){
    row80.push('');
    row80.push('');
  }
  aoa.push(row80);
  
  // Ligne 81 : Référence témoin (blanc)
  var row81=["référence du témoin",''];
  for(var i=0;i<prels.length;i++){
    var blancRef=getBlancForAgent(m,prels[i].agent);
    row81.push(blancRef);
    row81.push('');
  }
  aoa.push(row81);
  
  // Lignes 82-84 : masse témoin, concentration blanc, critère (vides)
  for(var lnum=82;lnum<=84;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Créer la feuille
  var ws=XLSX.utils.aoa_to_sheet(aoa);
  
  // Ajouter les fusions de cellules
  if(!ws['!merges'])ws['!merges']=[];
  
  // Fusions en-tête
  ws['!merges'].push({s:{r:0,c:1},e:{r:0,c:13}});
  ws['!merges'].push({s:{r:1,c:1},e:{r:1,c:13}});
  ws['!merges'].push({s:{r:3,c:2},e:{r:3,c:13}});
  ws['!merges'].push({s:{r:4,c:2},e:{r:4,c:13}});
  
  // Fusions A-B
  ws['!merges'].push({s:{r:9,c:0},e:{r:10,c:0}});
  for(var plageNum=0;plageNum<5;plageNum++){
    var startRow=14+plageNum*2;
    ws['!merges'].push({s:{r:startRow,c:0},e:{r:startRow+1,c:0}});
  }
  ws['!merges'].push({s:{r:32,c:0},e:{r:34,c:0}});
  ws['!merges'].push({s:{r:35,c:0},e:{r:37,c:0}});
  ws['!merges'].push({s:{r:38,c:0},e:{r:40,c:0}});
  
  // Fusions colonnes prélèvements (C-D, E-F, etc.)
  var fuseRows=[5,6,7,9,10,11,13,25,26,27,28,29,30,32,33,34,35,36,37,38,39,40,41,44,45,46,47,48,58,59,63,64,65,66,67,68,69,80,81];
  for(var ri=0;ri<fuseRows.length;ri++){
    var row=fuseRows[ri];
    for(var i=0;i<prels.length;i++){
      var startCol=2+i*2;
      ws['!merges'].push({s:{r:row,c:startCol},e:{r:row,c:startCol+1}});
    }
  }
  
  // Fusions plages horaires
  for(var plageNum=0;plageNum<5;plageNum++){
    for(var i=0;i<prels.length;i++){
      var startRow=14+plageNum*2;
      var startCol=2+i*2;
      ws['!merges'].push({s:{r:startRow,c:startCol},e:{r:startRow,c:startCol+1}});
      ws['!merges'].push({s:{r:startRow+1,c:startCol},e:{r:startRow+1,c:startCol+1}});
    }
  }
  
  // Largeurs de colonnes
  var cols=[{wch:50},{wch:20}];
  for(var i=0;i<prels.length;i++){
    cols.push({wch:15});
    cols.push({wch:15});
  }
  ws['!cols']=cols;
  
  return ws;
}

function createNonRegSheet(m,prels){
  var aoa=[];
  
  // Ligne 1-2 : préleveur et site
  aoa.push(['nom du préleveur','',m.preleveur||'']);
  aoa.push(['site','',m.clientSite||'']);
  aoa.push(['Matériel de mesure','']);
  
  // Ligne 4 : Prélèvement n°
  var row4=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row4.push(i+1);
    row4.push('');
  }
  aoa.push(row4);
  
  // Ligne 5 : agent chimique
  var row5=['agent chimique',''];
  for(var i=0;i<prels.length;i++){
    row5.push(prels[i].agent);
    row5.push('');
  }
  aoa.push(row5);
  
  // Lignes 6-7 : pompe + débitmètre
  var row6=['n° d\'identification','pompe'];
  var row7=['','débitmètre'];
  for(var i=0;i<prels.length;i++){
    var ad=prels[i].sub.agentData?prels[i].sub.agentData[prels[i].agent]:null;
    row6.push(ad&&ad.numPompe?ad.numPompe:'');
    row6.push('');
    row7.push(m.debitmetre||'');
    row7.push('');
  }
  aoa.push(row6);
  aoa.push(row7);
  
  // Ligne 8 : Support
  var row8=['Support','nature et marque'];
  for(var i=0;i<prels.length;i++){
    var ag=getAgentFromDB(prels[i].agent);
    var support=ag?(ag['Support de prélèvement']||''):'';
    row8.push(support);
    row8.push('');
  }
  aoa.push(row8);
  
  // Ligne 9 : Plages horaires
  aoa.push(['Plages horaires de prélèvement, durée du','']);
  
  // Ligne 10 : Prélèvement n° (répété)
  var row10=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row10.push(i+1);
    row10.push('');
  }
  aoa.push(row10);
  
  // Ligne 11 : date
  var row11=['date de prélèvement',''];
  for(var i=0;i<prels.length;i++){
    row11.push(formatDateFR(prels[i].sub.date)||'');
    row11.push('');
  }
  aoa.push(row11);
  
  // Lignes 12-31 : 10 plages horaires (2 lignes chacune)
  for(var plageNum=1;plageNum<=10;plageNum++){
    var rowDebut=['plage n°'+plageNum,'heure début n°C'+plageNum+'-P'+plageNum+'_'];
    var rowFin=['','heure fin n°C'+plageNum+'-P'+plageNum+'_'];
    
    for(var i=0;i<prels.length;i++){
      var plages=prels[i].sub.plages||[];
      var plage=plages[plageNum-1];
      
      rowDebut.push(plage&&plage.debut?plage.debut:'');
      rowDebut.push('');
      rowFin.push(plage&&plage.fin?plage.fin:'');
      rowFin.push('');
    }
    
    aoa.push(rowDebut);
    aoa.push(rowFin);
  }
  
  // Lignes 32-39 : Durées, exposition, EPI (vides)
  for(var lnum=32;lnum<=39;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 40 : Conditions ambiantes
  aoa.push(['Conditions ambiantes lors des prélèvements','']);
  
  // Ligne 41 : Prélèvement n°
  var row41=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row41.push(i+1);
    row41.push('');
  }
  aoa.push(row41);
  
  // Lignes 42-44 : Température
  var row42=['température ambiante (°C)','initiale'];
  var row43=['','finale'];
  var row44=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row42.push(cond&&cond.tempI?cond.tempI:'');
    row42.push('');
    row43.push(cond&&cond.tempF?cond.tempF:'');
    row43.push('');
    row44.push('');
    row44.push('');
  }
  aoa.push(row42);
  aoa.push(row43);
  aoa.push(row44);
  
  // Lignes 45-47 : Pression
  var row45=['pression atmosphérique (hPa)','initiale'];
  var row46=['','finale'];
  var row47=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row45.push(cond&&cond.pressionI?cond.pressionI:'');
    row45.push('');
    row46.push(cond&&cond.pressionF?cond.pressionF:'');
    row46.push('');
    row47.push('');
    row47.push('');
  }
  aoa.push(row45);
  aoa.push(row46);
  aoa.push(row47);
  
  // Lignes 48-50 : Humidité
  var row48=['humidité relative (%)','initiale'];
  var row49=['','finale'];
  var row50=['','moyenne'];
  for(var i=0;i<prels.length;i++){
    var cond=getConditionsForPrel(m,prels[i].sub);
    row48.push(cond&&cond.humiditeI?cond.humiditeI:'');
    row48.push('');
    row49.push(cond&&cond.humiditeF?cond.humiditeF:'');
    row49.push('');
    row50.push('');
    row50.push('');
  }
  aoa.push(row48);
  aoa.push(row49);
  aoa.push(row50);
  
  // Ligne 51 : Pression saturation (vide)
  var row51=['pression de saturation de la vapeur d\'eau (Pa)',''];
  for(var i=0;i<prels.length;i++){
    row51.push('');
    row51.push('');
  }
  aoa.push(row51);
  
  // Ligne 52 : Volume prélevé
  aoa.push(['Volume prélevé','']);
  
  // Ligne 53 : Prélèvement n°
  var row53=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row53.push(i+1);
    row53.push('');
  }
  aoa.push(row53);
  
  // Ligne 54 : Vérification débit
  aoa.push(['Volume prélevé avec pompe - Vérification du débit','']);
  
  // Lignes 55-56 : Débits initial et final
  var row55=['débit initial de la pompe (L/min)',''];
  var row56=['débit final de la pompe (L/min)',''];
  for(var i=0;i<prels.length;i++){
    var ad=prels[i].sub.agentData?prels[i].sub.agentData[prels[i].agent]:null;
    row55.push(ad&&ad.debitInitial?ad.debitInitial:'');
    row55.push('');
    row56.push(ad&&ad.debitFinal?ad.debitFinal:'');
    row56.push('');
  }
  aoa.push(row55);
  aoa.push(row56);
  
  // Lignes 57-73 : débit moyen, volume, vérification DLS, résultats labo (vides)
  for(var lnum=57;lnum<=73;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 74 : RESULTATS
  aoa.push(['RESULTATS','']);
  
  // Ligne 75 : Prélèvement n°
  var row75=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row75.push(i+1);
    row75.push('');
  }
  aoa.push(row75);
  
  // Lignes 76-78 : agent, type VLEP, type prélèvement
  var row76=['agent chimique',''];
  var row77=['type de VLEP',''];
  var row78=['type de prélèvement',''];
  for(var i=0;i<prels.length;i++){
    var p=prels[i];
    row76.push(p.agent);
    row76.push('');
    row77.push(''); // vide pour non-reg
    row77.push('');
    row78.push(p.type); // 8h ou CT
    row78.push('');
  }
  aoa.push(row76);
  aoa.push(row77);
  aoa.push(row78);
  
  // Lignes 79-88 : opérateur, date, réf, résultats (vides/partiels)
  var row79=['opérateur',''];
  var row80=['date de prélèvement',''];
  var row81=['référence de l\'échantillon',''];
  for(var i=0;i<prels.length;i++){
    var p=prels[i];
    row79.push(p.sub.operateur||'');
    row79.push('');
    row80.push(formatDateFR(p.sub.date)||'');
    row80.push('');
    var ad=p.sub.agentData?p.sub.agentData[p.agent]:null;
    row81.push(ad&&ad.refEchantillon?ad.refEchantillon:'');
    row81.push('');
  }
  aoa.push(row79);
  aoa.push(row80);
  aoa.push(row81);
  
  // Lignes 82-88 : résultats bruts, EPI, VLEP (vides)
  for(var lnum=82;lnum<=88;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Ligne 89 : Validation
  aoa.push(['Validation des prélèvements','']);
  
  // Ligne 90 : Prélèvement n°
  var row90=['Prélèvement n°',''];
  for(var i=0;i<prels.length;i++){
    row90.push(i+1);
    row90.push('');
  }
  aoa.push(row90);
  
  // Ligne 91 : Variation débit (vide)
  var row91=['Variation du débit avant et après prélèvement (< 5%)',''];
  for(var i=0;i<prels.length;i++){
    row91.push('');
    row91.push('');
  }
  aoa.push(row91);
  
  // Ligne 92 : Référence témoin
  var row92=["référence du témoin",''];
  for(var i=0;i<prels.length;i++){
    var blancRef=getBlancForAgent(m,prels[i].agent);
    row92.push(blancRef);
    row92.push('');
  }
  aoa.push(row92);
  
  // Lignes 93-95 : masse témoin, concentration, critère (vides)
  for(var lnum=93;lnum<=95;lnum++){
    var rowEmpty=['',''];
    for(var i=0;i<prels.length;i++){
      rowEmpty.push('');
      rowEmpty.push('');
    }
    aoa.push(rowEmpty);
  }
  
  // Créer la feuille
  var ws=XLSX.utils.aoa_to_sheet(aoa);
  
  // Ajouter les fusions de cellules
  if(!ws['!merges'])ws['!merges']=[];
  
  // Fusions en-tête
  ws['!merges'].push({s:{r:0,c:2},e:{r:0,c:13}});
  ws['!merges'].push({s:{r:1,c:2},e:{r:1,c:13}});
  
  // Fusions A-B
  ws['!merges'].push({s:{r:5,c:0},e:{r:6,c:0}});
  for(var plageNum=0;plageNum<10;plageNum++){
    var startRow=11+plageNum*2;
    ws['!merges'].push({s:{r:startRow,c:0},e:{r:startRow+1,c:0}});
  }
  ws['!merges'].push({s:{r:41,c:0},e:{r:43,c:0}});
  ws['!merges'].push({s:{r:44,c:0},e:{r:46,c:0}});
  ws['!merges'].push({s:{r:47,c:0},e:{r:49,c:0}});
  
  // Fusions colonnes prélèvements
  var fuseRows=[3,4,5,6,7,9,10,40,41,42,43,44,45,46,47,48,49,50,52,53,54,55,56,74,75,76,77,78,79,80,81,89,90,91,92];
  for(var ri=0;ri<fuseRows.length;ri++){
    var row=fuseRows[ri];
    for(var i=0;i<prels.length;i++){
      var startCol=2+i*2;
      ws['!merges'].push({s:{r:row,c:startCol},e:{r:row,c:startCol+1}});
    }
  }
  
  // Fusions plages horaires
  for(var plageNum=0;plageNum<10;plageNum++){
    for(var i=0;i<prels.length;i++){
      var startRow=11+plageNum*2;
      var startCol=2+i*2;
      ws['!merges'].push({s:{r:startRow,c:startCol},e:{r:startRow,c:startCol+1}});
      ws['!merges'].push({s:{r:startRow+1,c:startCol},e:{r:startRow+1,c:startCol+1}});
    }
  }
  
  // Largeurs de colonnes
  var cols=[{wch:50},{wch:20}];
  for(var i=0;i<prels.length;i++){
    cols.push({wch:15});
    cols.push({wch:15});
  }
  ws['!cols']=cols;
  
  return ws;
}

// Fonction helper pour récupérer les conditions ambiantes d'un sous-prélèvement
function getConditionsForPrel(m,subPrel){
  if(!m.conditionsAmbiantes||m.conditionsAmbiantes.length===0)return null;
  // Matcher par date si possible
  if(subPrel.date){
    for(var i=0;i<m.conditionsAmbiantes.length;i++){
      if(m.conditionsAmbiantes[i].date===subPrel.date)return m.conditionsAmbiantes[i];
    }
  }
  // Fallback: première condition
  return m.conditionsAmbiantes[0];
}

// Fonction helper pour récupérer la référence du blanc pour un agent
function getBlancForAgent(m,agentName){
  if(!m.blancs||m.blancs.length===0)return '';
  for(var i=0;i<m.blancs.length;i++){
    var b=m.blancs[i];
    if(b.agents&&b.agents.indexOf(agentName)!==-1){
      return b.ref||'';
    }
  }
  return '';
}



function createEchantillonsSheet(m, regPrels, nonRegPrels){
  var aoa = [];
  
  // En-tête
  aoa.push(['Nom de l\'échantillon', 'Date', 'Numéro de lot', 'Type d\'échantillon', 'Priorité air', 'Matrice']);
  
  // Collecter tous les échantillons (REG + NON REG) - dédupliquer par réf
  var allPrels = regPrels.concat(nonRegPrels);
  var seenRefs = {};
  
  // Ajouter les échantillons (dédupliqués)
  allPrels.forEach(function(p){
    var ad = p.sub.agentData ? p.sub.agentData[p.agent] : null;
    var ref = ad && ad.refEchantillon ? ad.refEchantillon : '';
    if(!ref) return; // skip empty refs
    if(seenRefs[ref]) return; // skip duplicates
    seenRefs[ref] = true;
    
    var date = p.sub.date ? formatDateFR(p.sub.date) : '';
    
    aoa.push([
      ref,                           // Nom de l'échantillon
      date,                          // Date (JJ/MM/AAAA)
      '',                            // Numéro de lot (vide)
      'Echantillon',                 // Type
      'Standard (J0+9)',             // Priorité
      'Air des lieux de Travail'     // Matrice
    ]);
  });
  
  // Ajouter les blancs
  if(m.blancs && m.blancs.length > 0){
    m.blancs.forEach(function(b){
      var ref = b.ref || '';
      if(!ref || seenRefs[ref]) return;
      seenRefs[ref] = true;
      var date = b.date ? formatDateFR(b.date) : '';
      
      aoa.push([
        ref,                           // Nom de l'échantillon (ref blanc)
        date,                          // Date (JJ/MM/AAAA)
        '',                            // Numéro de lot (vide)
        'Blanc',                       // Type
        'Standard (J0+9)',             // Priorité
        'Air des lieux de Travail'     // Matrice
      ]);
    });
  }
  
  var ws = XLSX.utils.aoa_to_sheet(aoa);
  
  // Largeurs de colonnes
  ws['!cols'] = [
    {wch: 25}, // Nom échantillon
    {wch: 12}, // Date
    {wch: 15}, // Numéro de lot
    {wch: 18}, // Type
    {wch: 18}, // Priorité
    {wch: 30}  // Matrice
  ];
  
  return ws;
}

// Feuille Relevé d'activité
function createActiviteSheet(m){
  var aoa=[];
  
  // En-tête
  aoa.push(['Relevé d\'activité - '+m.clientSite]);
  aoa.push(['Préleveur: '+(m.preleveur||''),'','Débitmètre: '+(m.debitmetre||'')]);
  aoa.push([]);
  
  // En-tête tableau
  aoa.push(['GEH','Opérateur','Agent(s) chimique(s)','Type','Date','Plage horaire','Durée','Observations']);
  
  // Données
  m.prelevements.forEach(function(p){
    p.subPrelevements.forEach(function(sb,si){
      var agentNames=p.agents.map(function(a){return a.name;}).join(', ');
      var plagesStr='';
      var dureeTotale=0;
      if(sb.plages){
        plagesStr=sb.plages.filter(function(pl){return pl.debut||pl.fin;}).map(function(pl){
          return(pl.debut||'?')+' - '+(pl.fin||'?');
        }).join(' / ');
        sb.plages.forEach(function(pl){
          if(pl.debut&&pl.fin){
            var d=pl.debut.split(':'),f=pl.fin.split(':');
            var diff=(parseInt(f[0])*60+parseInt(f[1]))-(parseInt(d[0])*60+parseInt(d[1]));
            if(diff>0)dureeTotale+=diff;
          }
        });
      }
      var dureeStr=dureeTotale>0?(Math.floor(dureeTotale/60)+'h'+(dureeTotale%60<10?'0':'')+(dureeTotale%60)):'';
      
      aoa.push([
        p.gehNum+' - '+(p.gehName||''),
        sb.operateur||'',
        agentNames,
        p.type+(p.isReglementaire?' (Régl.)':' (Non-régl.)'),
        formatDateFR(sb.date)||'',
        plagesStr,
        dureeStr,
        sb.observations||''
      ]);
    });
  });
  
  var ws=XLSX.utils.aoa_to_sheet(aoa);
  
  // Fusions en-tête
  if(!ws['!merges'])ws['!merges']=[];
  ws['!merges'].push({s:{r:0,c:0},e:{r:0,c:7}});
  
  // Largeurs
  ws['!cols']=[
    {wch:25},{wch:18},{wch:30},{wch:15},{wch:12},{wch:25},{wch:10},{wch:30}
  ];
  
  return ws;
}

// Fonction helper pour formater les dates en JJ/MM/AAAA
function formatDateFR(dateStr){
  if(!dateStr) return '';
  
  // Si la date est au format AAAA-MM-JJ (format ISO)
  if(dateStr.match(/^\d{4}-\d{2}-\d{2}$/)){
    var parts = dateStr.split('-');
    return parts[2] + '/' + parts[1] + '/' + parts[0]; // JJ/MM/AAAA
  }
  
  // Si déjà au bon format ou autre, retourner tel quel
  return dateStr;
}


// ═══════════════════════════════════════════════════════════════════════════════
// TIMER CT - Chronomètre pour prélèvements Court Terme
// © 2025 Quentin THOMAS
// ═══════════════════════════════════════════════════════════════════════════════

// Ajouter au state initial (dans la fonction d'initialisation)
// state.timers = {}; // { prelId_subIdx: { startTime, elapsed, interval } }

function startCTTimer(prelId, subIdx){
  var key = prelId + '_' + subIdx;
  
  // Si déjà un timer en cours, l'arrêter
  if(state.timers && state.timers[key] && state.timers[key].interval){
    clearInterval(state.timers[key].interval);
  }
  
  if(!state.timers) state.timers = {};
  
  // Démarrer le timer
  var startTime = Date.now();
  state.timers[key] = {
    startTime: startTime,
    elapsed: 0,
    interval: setInterval(function(){
      updateTimerDisplay(key);
    }, 1000)
  };
  
  // Persister le timer
  saveTimers();
  
  // Remplir l'heure de début automatiquement
  var now = new Date();
  var heureDebut = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
  
  var m = getCurrentMission();
  if(!m) return;
  
  var prel = m.prelevements.find(function(p){ return p.id === prelId; });
  if(!prel) return;
  
  var sub = prel.subPrelevements[subIdx];
  if(!sub) return;
  
  if(!sub.plages || sub.plages.length === 0){
    sub.plages = [{debut: '', fin: ''}];
  }
  
  // Trouver la première plage vide
  var plageIdx = -1;
  for(var i = 0; i < sub.plages.length; i++){
    if(!sub.plages[i].debut){
      plageIdx = i;
      break;
    }
  }
  
  if(plageIdx === -1){
    // Toutes les plages sont remplies, ajouter une nouvelle
    sub.plages.push({debut: heureDebut, fin: ''});
  } else {
    sub.plages[plageIdx].debut = heureDebut;
  }
  
  saveData('vlep_missions_v3', state.missions);
  render();
}

function stopCTTimer(prelId, subIdx){
  var key = prelId + '_' + subIdx;
  
  if(!state.timers || !state.timers[key]) return;
  
  // Arrêter le timer
  if(state.timers[key].interval){
    clearInterval(state.timers[key].interval);
  }
  
  // Remplir l'heure de fin automatiquement
  var now = new Date();
  var heureFin = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
  
  var m = getCurrentMission();
  if(!m) return;
  
  var prel = m.prelevements.find(function(p){ return p.id === prelId; });
  if(!prel) return;
  
  var sub = prel.subPrelevements[subIdx];
  if(!sub) return;
  
  // Trouver la dernière plage avec un début mais sans fin
  var plageIdx = -1;
  for(var i = sub.plages.length - 1; i >= 0; i--){
    if(sub.plages[i].debut && !sub.plages[i].fin){
      plageIdx = i;
      break;
    }
  }
  
  if(plageIdx !== -1){
    sub.plages[plageIdx].fin = heureFin;
  }
  
  // Nettoyer le timer
  delete state.timers[key];
  saveTimers();
  
  saveData('vlep_missions_v3', state.missions);
  render();
}

// Persistence des timers
function saveTimers(){
  var data={};
  for(var key in state.timers){
    if(state.timers[key]&&state.timers[key].startTime){
      data[key]={startTime:state.timers[key].startTime};
    }
  }
  try{localStorage.setItem('vlep_timers',JSON.stringify(data));}catch(e){}
}

function restoreTimers(){
  try{
    var data=JSON.parse(localStorage.getItem('vlep_timers')||'{}');
    for(var key in data){
      if(data[key].startTime){
        state.timers[key]={
          startTime:data[key].startTime,
          elapsed:Math.floor((Date.now()-data[key].startTime)/1000),
          interval:setInterval((function(k){return function(){updateTimerDisplay(k);};})(key),1000)
        };
      }
    }
  }catch(e){}
}

function updateTimerDisplay(key){
  if(!state.timers || !state.timers[key]) return;
  
  var timer = state.timers[key];
  var elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
  timer.elapsed = elapsed;
  
  // Mettre à jour l'affichage
  var element = document.getElementById('timer-display-' + key);
  if(element){
    var minutes = Math.floor(elapsed / 60);
    var seconds = elapsed % 60;
    element.textContent = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    
    // Alerte à 15 minutes
    if(elapsed === 900){ // 15 minutes
      element.style.color = '#ef4444';
      element.style.fontWeight = 'bold';
      // Vibration (3 pulses longues)
      try {
        if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
      } catch(e){}
      // Son
      try {
        var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWe77einTxELTqXh8LljHAU7k9r0x3ImBSh+zPLaizsIFWS56+qnUBEKTKPh8rpmHgU+m9z0zHUpBSh/zfPaizsIFWO46uunThELTaTi8bplHgU8mtr0zHYrBSh+zfPbiTsIFWS46uunUBEKTKPh8r1pHgU/nN301XcsBSh/zfPbiTsIFWS46+ymURAKTKPi8bxmHgU9mtr0zHYrBSh/zfPbizsIFWS46+ymUhELTKTi8bxmHgU9mtr0zHYrBSh/zfPbiTwIFWO46+ymUhAKTKPi8b1nHgU/m9301HgrBSh/zfPbiTsIFWS46+ymURAKTKPh8rxnHgU+m9v00nYpBSh/zPPbiTsIFWO46uunUBEKTKPh8rxnHgU+m9z00nYqBSh/zPPaiTsIFWS46+ymUhEKTKPi8r1oHgU/nNz0z3cpBSh/zfPaiTsIFWS46+ymUhELTKPi8r1oHgU+m9z00nYpBSh/zfPbiTsIFWO46+ymUhEKTKPi8r1pHgU/nN301HcpBSh/zfPaiTsIFWS56+ymUhAKTKPi8r1pHgU+m9301HgrBSiAzfPbiTsIFWO46+ymUhELTKPi8r1pHgU/nN301XcsBSiAzfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9z01HYpBSh/zfPaiTsIFWS46+ymUhEKTKPi8r1pHgVAm9z01XcsBSh/zfPaiTsIFWS46+ymURAKTKPi8r1pHgU+m9301HYpBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU/nN301XcsBSh/zfPaiTsIFWS46+ymUhAKTKPi8r1pHgU+m9z00nYpBSh/zfPaiTsIFWS46+ymUhEKTKPi8r1pHgU/nN301XcsBSh/zfPaiTsIFWS46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHgU+m9301HYrBSh/zfPaiTsIFWO46+ymUhEKTKPi8r1pHg==');
        audio.play();
      } catch(e){}
    }
    // Rappel vibration à 14min (1 min avant)
    if(elapsed === 840){
      try {
        if(navigator.vibrate) navigator.vibrate([300, 100, 300]);
      } catch(e){}
    }
  }
}

function getTimerDisplay(prelId, subIdx){
  var key = prelId + '_' + subIdx;
  
  if(!state.timers || !state.timers[key]){
    return '';
  }
  
  var elapsed = state.timers[key].elapsed || 0;
  var minutes = Math.floor(elapsed / 60);
  var seconds = elapsed % 60;
  var timeStr = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
  
  var color = elapsed >= 900 ? '#ef4444' : '#0066b3';
  
  return '<div style="background:#f0f7fc;border:2px solid '+color+';border-radius:8px;padding:12px;margin:8px 0;text-align:center;"><div style="font-size:11px;color:#64748b;margin-bottom:4px;">⏱️ Chronomètre CT</div><div id="timer-display-'+key+'" style="font-size:32px;font-weight:bold;color:'+color+';font-family:monospace;">'+timeStr+'</div><button class="btn btn-danger" style="margin-top:8px;" onclick="stopCTTimer('+prelId+','+subIdx+');">⏹️ Arrêter</button></div>';
}

function isTimerRunning(prelId, subIdx){
  var key = prelId + '_' + subIdx;
  return state.timers && state.timers[key] && state.timers[key].interval;
}


function renderDbTerrain(){
  return'<div style="position:sticky;top:-16px;background:linear-gradient(135deg, #004d87 0%, #0066b3 60%, #1a8fd4 100%);margin:-16px -16px 0;padding:16px;z-index:10;"><button class="back-btn" style="color:white;" onclick="state.view=\'home\';render();">'+ICONS.arrowLeft+' Accueil</button><h1 style="color:white;margin:8px 0;">'+ICONS.search+' Base de données terrain</h1><div class="search-box"><span class="search-icon">'+ICONS.search+'</span><input type="text" class="search-input" id="db-search-input" placeholder="Rechercher par nom ou N° CAS..." oninput="updateDbResults();"></div></div><div id="results-count" style="color:white;font-size:13px;margin:12px 0;">Tapez pour rechercher</div><div id="agent-results"></div>';
}

function updateDbResults(){
  var i=document.getElementById('db-search-input');
  var c=document.getElementById('results-count');
  var r=document.getElementById('agent-results');
  if(!i||!c||!r)return;
  var s=i.value.toLowerCase().trim();
  if(s.length<2){c.textContent='Tapez au moins 2 caractères';r.innerHTML='';return;}
  var f=state.agentsDB.filter(function(a){
    var n=(a['Agent chimique']||'').toLowerCase();
    var cs=(a['N° CAS']||'').toLowerCase();
    return n.indexOf(s)!==-1||cs.indexOf(s)!==-1;
  });
  c.textContent=f.length+' agent(s) trouvé(s)';
  var h='';
  f.slice(0,30).forEach(function(a){
    h+='<div class="agent-card"><div class="agent-card-name">'+escapeHtml(a['Agent chimique'])+'</div><div class="agent-card-cas">CAS : '+escapeHtml(a['N° CAS']||'-')+'</div><div class="agent-card-grid">';
    var cmr=a['CMR (règlement CLP)']||'';
    if(cmr)h+='<div class="agent-card-field full"><div class="agent-card-field-label">CMR</div><div class="agent-card-field-value cmr">'+escapeHtml(cmr)+'</div></div>';
    h+='<div class="agent-card-field"><div class="agent-card-field-label">VLEP 8h</div><div class="agent-card-field-value highlight">'+escapeHtml(a['VLEP 8h (mg/m3)']||'-')+' mg/m³</div></div><div class="agent-card-field"><div class="agent-card-field-label">VLEP CT</div><div class="agent-card-field-value highlight">'+escapeHtml(a['VLEP CT (mg/m3)']||'-')+' mg/m³</div></div>';
    h+='<div class="agent-card-field"><div class="agent-card-field-label">Débit max 8h</div><div class="agent-card-field-value">'+escapeHtml(a['débit max  8h (L/min)']||a['débit max 8h (L/min)']||'-')+' L/min</div></div><div class="agent-card-field"><div class="agent-card-field-label">Débit max CT</div><div class="agent-card-field-value">'+escapeHtml(a['débit max CT (L/min)']||'-')+' L/min</div></div>';
    // FIX #1: Code analytique avec les deux noms de colonnes
    var codeAnalyse=getCodeAnalytique(a);
    if(codeAnalyse)h+='<div class="agent-card-field full"><div class="agent-card-field-label">Code analyse</div><div class="agent-card-field-value">'+escapeHtml(codeAnalyse)+'</div></div>';
    var pos=a['positionnement du support']||'';
    if(pos)h+='<div class="agent-card-field full"><div class="agent-card-field-label">Positionnement support</div><div class="agent-card-field-value">'+escapeHtml(pos)+'</div></div>';
    var lab=a['Laboratoire\nsous-traitant']||a['Laboratoire sous-traitant']||'';
    if(lab)h+='<div class="agent-card-field full"><div class="agent-card-field-label">Laboratoire sous-traitant</div><div class="agent-card-field-value">'+escapeHtml(lab)+'</div></div>';
    var com=a['commentaire (interférent, impact des conditions ambiantes)']||'';
    if(com)h+='<div class="agent-card-field full"><div class="agent-card-field-label">Commentaire</div><div class="agent-card-field-value">'+escapeHtml(com)+'</div></div>';
    var cons=a['conservation après prélèvement (t°/durée max)']||'';
    if(cons)h+='<div class="agent-card-field full"><div class="agent-card-field-label">Conservation</div><div class="agent-card-field-value">'+escapeHtml(cons)+'</div></div>';
    h+='<div class="agent-card-field"><div class="agent-card-field-label">Code support</div><div class="agent-card-field-value">'+escapeHtml(a['Code support']||'-')+'</div></div><div class="agent-card-field"><div class="agent-card-field-label">Code prétraitement</div><div class="agent-card-field-value">'+escapeHtml(a['Code prétraitement']||'-')+'</div></div></div></div>';
  });
  r.innerHTML=h;
}

function renderDbFull(){
  var h='<button class="back-btn" onclick="state.view=\'home\';render();">'+ICONS.arrowLeft+' Accueil</button><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;"><div><h1>'+ICONS.database+' Base de données complète</h1><p class="subtitle">'+state.agentsDB.length+' agents</p></div><button class="btn btn-blue btn-small" onclick="state.showModal=\'importDB\';render();">'+ICONS.upload+' Importer</button></div></div>';
  if(state.agentsDB.length===0)h+='<div class="empty-state"><div class="empty-state-icon">'+ICONS.database+'</div><p>Aucune donnée</p></div>';
  if(state.showModal==='importDB')h+='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>Importer</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div><div class="info-box"><p>1. Ouvrez Excel</p><p>2. Sélectionnez A à AU (sauf C)</p><p>3. Copiez et collez ci-dessous</p></div><textarea class="input" id="importDBText" rows="8" placeholder="Collez ici..."></textarea><div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-blue" onclick="importDB();">Importer</button></div></div></div>';
  return h;
}

function importDB(){
  var t=document.getElementById('importDBText').value;
  if(!t.trim()){alert('Collez vos données');return;}
  try{
    var rw=[],cr='',iq=false;
    for(var i=0;i<t.length;i++){
      var c=t[i];
      if(c==='"'){iq=!iq;cr+=c;}
      else if(c==='\n'&&!iq){if(cr.trim())rw.push(cr);cr='';}
      else cr+=c;
    }
    if(cr.trim())rw.push(cr);
    var pr=function(ln){
      var cl=[],ce='',q=false;
      for(var i=0;i<ln.length;i++){
        var c=ln[i];
        if(c==='"')q=!q;
        else if(c==='\t'&&!q){cl.push(ce.replace(/^"|"$/g,'').trim());ce='';}
        else ce+=c;
      }
      cl.push(ce.replace(/^"|"$/g,'').trim());
      return cl;
    };
    var hd=pr(rw[0]);
    var db=[];
    for(var j=1;j<rw.length;j++){
      var vl=pr(rw[j]);
      var ob={};
      for(var k=0;k<hd.length&&k<=50;k++){if(hd[k])ob[hd[k]]=vl[k]||'';}
      if(ob['Agent chimique'])db.push(ob);
    }
    state.agentsDB=db;
    saveData('vlep_database',db);
    state.showModal=null;
    alert(''+ICONS.check+' '+db.length+' agents importés !');
    render();
  }catch(e){alert('Erreur: '+e.message);}
}

loadData();
restoreTimers();

// ===== SAISIE RAPIDE =====
function openQuickEntry(){
  state.quickMission={
    clientSite:'',
    preleveur:'',
    debitmetre:'',
    gehs:[{id:generateId(),num:1,name:''}],
    agents:[],
    prelevements:[]
  };
  state.quickAgentSearch='';
  state.view='quick-entry';
  render();
}

function renderQuickEntry(){
  var q=state.quickMission;
  var h='<button class="back-btn" onclick="state.view=\'terrain-list\';render();">'+ICONS.arrowLeft+' Retour</button>';
  h+='<div class="card"><h1>'+ICONS.zap+' Saisie rapide</h1><p class="subtitle">Créez une mission directement sur le terrain</p></div>';
  
  // Infos générales
  h+='<div class="card"><h2>'+ICONS.list+' Informations</h2>';
  h+='<div class="field"><label class="label">Client / Site *</label><input type="text" class="input" id="quick-client" value="'+escapeHtml(q.clientSite)+'" placeholder="Ex: Entreprise ABC" onchange="state.quickMission.clientSite=this.value;"></div>';
  h+='<div class="field"><label class="label">Préleveur</label><input type="text" class="input" id="quick-preleveur" value="'+escapeHtml(q.preleveur)+'" placeholder="Votre nom" onchange="state.quickMission.preleveur=this.value;"></div>';
  h+='<div class="field"><label class="label">Débitmètre</label><input type="text" class="input" id="quick-debitmetre" value="'+escapeHtml(q.debitmetre)+'" placeholder="N° débitmètre" onchange="state.quickMission.debitmetre=this.value;"></div>';
  h+='</div>';
  
  // GEH
  h+='<div class="card"><h2>'+ICONS.folder+' GEH</h2>';
  q.gehs.forEach(function(g,i){
    h+='<div class="geh-item"><div class="geh-num">'+(i+1)+'</div><input type="text" class="geh-input" value="'+escapeHtml(g.name)+'" placeholder="Nom du GEH..." onchange="updateQuickGeh('+i+',this.value);">';
    if(q.gehs.length>1)h+='<button class="agent-delete" onclick="removeQuickGeh('+i+');">'+ICONS.trash+'</button>';
    h+='</div>';
  });
  h+='<button class="btn btn-gray btn-small" onclick="addQuickGeh();">+ Ajouter GEH</button>';
  h+='</div>';
  
  // Agents
  h+='<div class="card"><h2>'+ICONS.beaker+' Agents chimiques</h2>';
  h+='<div class="search-box"><span class="search-icon">'+ICONS.search+'</span><input type="text" class="search-input" id="quick-agent-search" placeholder="Rechercher un agent..." value="'+escapeHtml(state.quickAgentSearch)+'" oninput="handleQuickAgentSearch(this.value);"></div>';
  h+='<div id="quick-search-results">';
  if(state.quickAgentSearch&&state.quickAgentSearch.length>=2){
    var results=searchAgentsDB(state.quickAgentSearch);
    var filtered=results.filter(function(x){return!q.agents.some(function(a){return a.name===x;});});
    if(filtered.length>0){
      h+='<div class="search-results">';
      filtered.slice(0,8).forEach(function(x){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addQuickAgent(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  h+='</div>';
  h+='<button class="btn btn-gray btn-small mt-8" onclick="state.showModal=\'quickAddManual\';render();">+ Agent manuel</button>';
  
  if(q.agents.length>0){
    h+='<div class="section-title" style="color:#374151;margin-top:16px;">Agents sélectionnés ('+q.agents.length+')</div>';
    q.agents.forEach(function(a,i){
      h+='<div class="agent-item"><div class="agent-color" style="background:'+AGENT_COLORS[i%AGENT_COLORS.length]+';"></div><div class="agent-name">'+escapeHtml(a.name)+'</div>';
      h+='<div class="agent-badges"><span class="agent-badge agent-badge-8h '+(a.is8h?'active':'')+'" onclick="toggleQuickAgent8h('+i+');">8h</span><span class="agent-badge agent-badge-ct '+(a.isCT?'active':'')+'" onclick="toggleQuickAgentCT('+i+');">CT</span></div>';
      h+='<button class="agent-delete" onclick="removeQuickAgent('+i+');">'+ICONS.trash+'</button></div>';
    });
  }
  h+='</div>';
  
  // Prélèvements configurés
  if(q.agents.length>0&&q.gehs.some(function(g){return g.name;})){
    h+='<div class="card"><h2>'+ICONS.link+' Prélèvements à créer</h2>';
    h+='<p class="subtitle mb-12">Sélectionnez les combinaisons agent/GEH</p>';
    
    var validGehs=q.gehs.filter(function(g){return g.name;});
    q.agents.forEach(function(ag,ai){
      h+='<div class="affect-card" style="border-left:4px solid '+AGENT_COLORS[ai%AGENT_COLORS.length]+';"><div class="affect-header"><div class="affect-agent">'+escapeHtml(ag.name)+'</div><button class="affect-reg-toggle '+(ag.isReg?'':'nonreg')+'" onclick="toggleQuickAgentReg('+ai+');">'+(ag.isReg!==false?'Réglementaire':'Non-régl.')+'</button></div>';
      validGehs.forEach(function(g,gi){
        if(!ag.gehs)ag.gehs={};
        if(!ag.gehs[g.id])ag.gehs[g.id]={has8h:false,hasCT:false};
        var gaf=ag.gehs[g.id];
        h+='<div class="affect-geh-row"><div class="affect-geh-name">'+(gi+1)+'. '+escapeHtml(g.name)+'</div><div class="affect-geh-badges">';
        if(ag.is8h)h+='<span class="affect-mini-badge '+(gaf.has8h?'active-8h':'')+'" onclick="toggleQuickGehAffect('+ai+',\''+g.id+'\',\'8h\');">8h</span>';
        if(ag.isCT)h+='<span class="affect-mini-badge '+(gaf.hasCT?'active-ct':'')+'" onclick="toggleQuickGehAffect('+ai+',\''+g.id+'\',\'CT\');">CT</span>';
        h+='</div></div>';
      });
      h+='</div>';
    });
    h+='</div>';
  }
  
  // Bouton créer
  var canCreate=q.clientSite&&q.agents.length>0&&q.gehs.some(function(g){return g.name;})&&countQuickPrelevements()>0;
  var prelCount=countQuickPrelevements();
  if(canCreate){
    h+='<button class="btn btn-primary" onclick="createQuickMission();">'+ICONS.play+' Créer la mission ('+prelCount+' prél.)</button>';
  }else{
    h+='<div class="info-box info-box-warning"><p>Pour créer la mission :</p>';
    if(!q.clientSite)h+='<p>• Renseignez le client/site</p>';
    if(!q.gehs.some(function(g){return g.name;}))h+='<p>• Ajoutez au moins un GEH</p>';
    if(q.agents.length===0)h+='<p>• Sélectionnez au moins un agent</p>';
    if(q.agents.length>0&&prelCount===0)h+='<p>• Affectez les agents aux GEH</p>';
    h+='</div>';
  }
  
  // Modal ajout manuel
  if(state.showModal==='quickAddManual'){
    h+='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>Ajouter agent</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div><div class="field"><label class="label">Nom de l\'agent</label><input type="text" class="input" id="quick-manual-name" placeholder="Ex: Benzène"></div><div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-primary" onclick="addQuickManualAgent();">Ajouter</button></div></div></div>';
  }
  
  return h;
}

function handleQuickAgentSearch(value){
  state.quickAgentSearch=value;
  var container=document.getElementById('quick-search-results');
  if(!container)return;
  var q=state.quickMission;
  var h='';
  if(value&&value.length>=2){
    var results=searchAgentsDB(value);
    var filtered=results.filter(function(x){return!q.agents.some(function(a){return a.name===x;});});
    if(filtered.length>0){
      h+='<div class="search-results">';
      filtered.slice(0,8).forEach(function(x){
        h+='<div class="search-result-item" onmousedown="event.preventDefault();" onclick="addQuickAgent(\''+escapeJs(x)+'\');">'+escapeHtml(x)+'</div>';
      });
      h+='</div>';
    }
  }
  container.innerHTML=h;
}

function addQuickGeh(){
  var q=state.quickMission;
  q.gehs.push({id:generateId(),num:q.gehs.length+1,name:''});
  render();
}

function updateQuickGeh(i,v){
  state.quickMission.gehs[i].name=v.trim();
}

function removeQuickGeh(i){
  state.quickMission.gehs.splice(i,1);
  state.quickMission.gehs.forEach(function(g,idx){g.num=idx+1;});
  render();
}

function addQuickAgent(name){
  var q=state.quickMission;
  if(q.agents.some(function(a){return a.name===name;}))return;
  q.agents.push({name:name,is8h:hasVLEP8h(name),isCT:hasVLEPCT(name),isReg:true,gehs:{}});
  state.quickAgentSearch='';
  render();
}

function addQuickManualAgent(){
  var input=document.getElementById('quick-manual-name');
  var name=input?input.value.trim():'';
  if(!name){alert('Saisissez un nom');return;}
  var q=state.quickMission;
  if(q.agents.some(function(a){return a.name===name;})){alert('Agent déjà ajouté');return;}
  q.agents.push({name:name,is8h:true,isCT:true,isReg:true,isManual:true,gehs:{}});
  state.showModal=null;
  render();
}

function removeQuickAgent(i){
  state.quickMission.agents.splice(i,1);
  render();
}

function toggleQuickAgent8h(i){
  var a=state.quickMission.agents[i];
  if(!hasVLEP8h(a.name)&&!a.isManual)return;
  a.is8h=!a.is8h;
  if(!a.is8h&&!a.isCT)a.isCT=true;
  render();
}

function toggleQuickAgentCT(i){
  var a=state.quickMission.agents[i];
  if(!hasVLEPCT(a.name)&&!a.isManual)return;
  a.isCT=!a.isCT;
  if(!a.is8h&&!a.isCT)a.is8h=true;
  render();
}

function toggleQuickAgentReg(i){
  var a=state.quickMission.agents[i];
  a.isReg=!a.isReg;
  render();
}

function toggleQuickGehAffect(ai,gid,type){
  var a=state.quickMission.agents[ai];
  if(!a.gehs)a.gehs={};
  if(!a.gehs[gid])a.gehs[gid]={has8h:false,hasCT:false};
  if(type==='8h')a.gehs[gid].has8h=!a.gehs[gid].has8h;
  else a.gehs[gid].hasCT=!a.gehs[gid].hasCT;
  render();
}

function countQuickPrelevements(){
  var q=state.quickMission;
  var count=0;
  q.agents.forEach(function(a){
    if(!a.gehs)return;
    for(var gid in a.gehs){
      var g=a.gehs[gid];
      if(g.has8h)count+=(a.isReg!==false?3:1);
      if(g.hasCT)count+=1;
    }
  });
  return count;
}

function createQuickMission(){
  var q=state.quickMission;
  
  // Créer la mission
  var m=createEmptyMission();
  m.clientSite=q.clientSite;
  m.preleveur=q.preleveur;
  m.debitmetre=q.debitmetre;
  m.gehs=q.gehs.filter(function(g){return g.name;}).map(function(g,i){
    return{id:g.id,num:i+1,name:g.name};
  });
  m.agents=q.agents.map(function(a){
    return{name:a.name,is8h:a.is8h,isCT:a.isCT,isManual:a.isManual||false};
  });
  
  // Affectations
  q.agents.forEach(function(a){
    m.affectations[a.name]={isReg:a.isReg!==false,gehs:{}};
    if(a.gehs){
      for(var gid in a.gehs){
        m.affectations[a.name].gehs[gid]=a.gehs[gid];
      }
    }
    m.agentColors[a.name]=AGENT_COLORS[q.agents.indexOf(a)%AGENT_COLORS.length];
  });
  
  // Générer prélèvements
  generatePrelevements(m);
  m.status='encours';
  
  state.missions.push(m);
  saveData('vlep_missions_v3',state.missions);
  
  state.currentMissionId=m.id;
  state.view='terrain-mission';
  state.expandedGeh={};
  m.gehs.forEach(function(g){state.expandedGeh[g.id]=true;});
  
  render();
  alert(''+ICONS.check+' Mission créée avec '+m.prelevements.length+' prélèvement(s) !');
}

// ===== EXPORT / IMPORT MISSION JSON =====
function exportMissionJSON(id){
  var m=state.missions.find(function(x){return x.id===id;});
  if(!m){alert('Mission introuvable');return;}
  var exportData={_format:'VLEP_Mission_JSON',_version:'3.6',_exportDate:new Date().toISOString(),_author:'Quentin THOMAS',mission:JSON.parse(JSON.stringify(m))};
  var json=JSON.stringify(exportData,null,2);
  var blob=new Blob([json],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');
  var safeName=(m.clientSite||'mission').replace(/[^a-zA-Z0-9àâäéèêëïîôùûüçÀÂÄÉÈÊËÏÎÔÙÛÜÇ _-]/g,'').replace(/\s+/g,'_').substring(0,40);
  a.href=url;
  a.download='VLEP_Mission_'+safeName+'_'+String(m.id).slice(-6)+'.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function triggerImportMission(){
  var input=document.getElementById('import-mission-input');
  if(!input){
    input=document.createElement('input');
    input.type='file';
    input.accept='.json';
    input.style.display='none';
    input.id='import-mission-input';
    input.onchange=handleImportMission;
    document.body.appendChild(input);
  }
  input.value='';
  input.click();
}

function handleImportMission(event){
  var file=event.target?event.target.files[0]:null;
  if(!file)return;
  if(!file.name.endsWith('.json')){alert('Veuillez sélectionner un fichier .json');return;}
  var reader=new FileReader();
  reader.onload=function(e){
    importMissionFromText(e.target.result);
  };
  reader.readAsText(file);
}

function importMissionFromText(text){
  try{
    var data=JSON.parse(text);
    var mission=null;
    // Format standard
    if(data._format==='VLEP_Mission_JSON'&&data.mission){
      mission=data.mission;
    // Format QR code compact
    }else if(data._f==='VLEP'&&data.m){
      mission=data.m;
    // Format brut
    }else if(data.id&&data.gehs&&data.agents!==undefined){
      mission=data;
    }else{
      alert('Format non reconnu.\n\nAssurez-vous d\'importer des données VLEP Mission.');
      return;
    }
    // Vérifier si la mission existe déjà
    var exists=state.missions.some(function(m){return m.id===mission.id;});
    if(exists){
      if(!confirm('Une mission avec le même identifiant existe déjà.\n\nVoulez-vous l\'écraser ?'))return;
      state.missions=state.missions.filter(function(m){return m.id!==mission.id;});
    }
    state.missions.push(mission);
    saveData('vlep_missions_v3',state.missions);
    repairMissions();
    state.showModal=null;
    render();
    var name=mission.clientSite||'Sans nom';
    var pCount=0;
    if(mission.prelevements)mission.prelevements.forEach(function(p){if(p.subPrelevements)pCount+=p.subPrelevements.length;});
    var aCount=mission.agents?mission.agents.length:0;
    var gCount=mission.gehs?mission.gehs.filter(function(g){return g.name;}).length:0;
    alert('Mission importée avec succès !\n\n'+name+'\n'+gCount+' GEH • '+aCount+' agents • '+pCount+' sous-prélèvements\n\nStatut : '+(mission.status==='prepa'?'En préparation':(mission.status==='validee'?'Validée':(mission.status==='encours'?'En cours':'Terminée'))));
  }catch(err){
    alert('Erreur lors de l\'import :\n\n'+err.message+'\n\nVérifiez que les données sont valides.');
  }
}

// ===== QR CODE PARTAGE =====
function showQRCodeModal(id){
  state.qrMissionId=id;
  state.showModal='qrCode';
  render();
  // Générer le QR code après le render (pour que le DOM soit prêt)
  setTimeout(function(){generateQRCode(id);},100);
}

function renderQRCodeModal(){
  var m=state.missions.find(function(x){return x.id===state.qrMissionId;});
  if(!m)return'';
  
  var missionJson=JSON.stringify({_format:'VLEP_Mission_JSON',_version:'3.6',mission:JSON.parse(JSON.stringify(m))});
  var dataSize=missionJson.length;
  var isTooBig=dataSize>2500;
  
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content" style="text-align:center;"><div class="modal-header"><h2>'+ICONS.share+' Partager la mission</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div>';
  
  h+='<div style="font-weight:700;font-size:14px;margin-bottom:4px;">'+escapeHtml(m.clientSite||'Mission')+'</div>';
  h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;">'+m.gehs.filter(function(g){return g.name;}).length+' GEH • '+m.agents.length+' agents • Taille: '+(dataSize/1024).toFixed(1)+' Ko</div>';
  
  if(isTooBig){
    h+='<div class="info-box info-box-warning" style="text-align:left;"><p><strong>Mission trop volumineuse pour un QR code</strong></p><p style="font-size:11px;margin-top:4px;">Taille: '+(dataSize/1024).toFixed(1)+' Ko (max ~2.5 Ko pour un QR code)</p><p style="font-size:11px;margin-top:2px;">Utilisez l\'export JSON à la place.</p></div>';
  }else{
    h+='<div id="qr-container" style="display:flex;justify-content:center;margin:16px 0;"></div>';
    h+='<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Scannez ce QR code depuis un autre téléphone<br>avec VLEP Mission ouvert</div>';
  }
  
  h+='<div class="row mt-12">';
  h+='<button class="btn btn-gray" onclick="state.showModal=null;render();">Fermer</button>';
  if(!isTooBig){
    h+='<button class="btn btn-primary" onclick="downloadQRImage();">'+ICONS.download+' Sauver image</button>';
  }
  h+='<button class="btn btn-gray" onclick="state.showModal=null;exportMissionJSON('+m.id+');">'+ICONS.download+' JSON</button>';
  h+='</div>';
  
  h+='</div></div>';
  return h;
}

function generateQRCode(id){
  var container=document.getElementById('qr-container');
  if(!container)return;
  
  var m=state.missions.find(function(x){return x.id===id;});
  if(!m)return;
  
  // Compresser les données en retirant les champs inutiles pour le transfert
  var missionCopy=JSON.parse(JSON.stringify(m));
  // Nettoyer pour réduire la taille
  if(missionCopy.agentColors)delete missionCopy.agentColors;
  
  var json=JSON.stringify({_f:'VLEP',_v:'3.6',m:missionCopy});
  
  if(json.length>2500){
    container.innerHTML='<div style="color:var(--danger);font-size:12px;padding:20px;">Données trop volumineuses pour un QR code ('+(json.length/1024).toFixed(1)+' Ko)</div>';
    return;
  }
  
  container.innerHTML='';
  try{
    new QRCode(container,{
      text:json,
      width:256,
      height:256,
      colorDark:'#1a1a2e',
      colorLight:'#ffffff',
      correctLevel:QRCode.CorrectLevel.L
    });
  }catch(e){
    container.innerHTML='<div style="color:var(--danger);font-size:12px;padding:20px;">Erreur génération QR: '+escapeHtml(e.message)+'</div>';
  }
}

function downloadQRImage(){
  var container=document.getElementById('qr-container');
  if(!container)return;
  var canvas=container.querySelector('canvas');
  if(!canvas){
    // Essayer avec l'image
    var img=container.querySelector('img');
    if(img){
      var a=document.createElement('a');
      a.href=img.src;
      a.download='VLEP_QR_Mission.png';
      a.click();
    }
    return;
  }
  var a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='VLEP_QR_Mission.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Import depuis QR code (via scan camera ou collage texte)
function renderImportQRModal(){
  var h='<div class="modal show" onclick="if(event.target===this){state.showModal=null;render();}"><div class="modal-content"><div class="modal-header"><h2>'+ICONS.share+' Importer via QR / Texte</h2><button class="close-btn" onclick="state.showModal=null;render();">×</button></div>';
  
  h+='<div class="info-box"><p><strong>Comment ça marche :</strong></p><p style="font-size:11px;margin-top:4px;">1. Scannez le QR code avec l\'appareil photo de votre téléphone</p><p style="font-size:11px;">2. Copiez le texte obtenu</p><p style="font-size:11px;">3. Collez-le ci-dessous</p></div>';
  
  h+='<div class="field mt-12"><label class="label">Données de la mission (JSON)</label><textarea class="input" id="import-qr-text" rows="6" placeholder="Collez ici le contenu du QR code..." style="font-size:11px;font-family:monospace;"></textarea></div>';
  
  h+='<div class="row"><button class="btn btn-gray" onclick="state.showModal=null;render();">Annuler</button><button class="btn btn-success" onclick="doImportQR();">'+ICONS.check+' Importer</button></div>';
  
  h+='</div></div>';
  return h;
}

function doImportQR(){
  var textarea=document.getElementById('import-qr-text');
  var text=textarea?textarea.value.trim():'';
  if(!text){alert('Collez les données de la mission');return;}
  importMissionFromText(text);
}

// ===== DICTÉE VOCALE =====
var activeDictation=null;

function toggleDictation(prelId,subIdx){
  var SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    alert('La dictée vocale n\'est pas supportée par votre navigateur.\n\nUtilisez Chrome sur Android pour cette fonctionnalité.');
    return;
  }
  
  var key=prelId+'_'+subIdx;
  var btn=document.getElementById('dict-btn-'+prelId+'-'+subIdx);
  
  if(activeDictation&&activeDictation.key===key){
    activeDictation.recognition.stop();
    activeDictation=null;
    if(btn)btn.classList.remove('recording');
    return;
  }
  
  if(activeDictation){
    activeDictation.recognition.stop();
    var oldBtn=document.getElementById('dict-btn-'+activeDictation.prelId+'-'+activeDictation.subIdx);
    if(oldBtn)oldBtn.classList.remove('recording');
  }
  
  var recognition=new SpeechRecognition();
  recognition.lang='fr-FR';
  recognition.continuous=true;
  recognition.interimResults=true;
  
  var textarea=document.getElementById('obs-'+prelId+'-'+subIdx);
  var baseText=textarea?textarea.value:'';
  
  recognition.onresult=function(event){
    var transcript='';
    for(var i=event.resultIndex;i<event.results.length;i++){
      transcript+=event.results[i][0].transcript;
    }
    if(textarea){
      textarea.value=baseText+(baseText?' ':'')+transcript;
    }
    if(event.results[event.results.length-1].isFinal){
      baseText=textarea.value;
      updateSubFieldWithAutoDate(prelId,subIdx,'observations',textarea.value);
    }
  };
  
  recognition.onerror=function(event){
    if(event.error!=='aborted'&&event.error!=='no-speech'){
      alert('Erreur dictée : '+event.error);
    }
    activeDictation=null;
    if(btn)btn.classList.remove('recording');
  };
  
  recognition.onend=function(){
    if(textarea){
      updateSubFieldWithAutoDate(prelId,subIdx,'observations',textarea.value);
    }
    activeDictation=null;
    if(btn)btn.classList.remove('recording');
  };
  
  recognition.start();
  activeDictation={key:key,prelId:prelId,subIdx:subIdx,recognition:recognition};
  if(btn)btn.classList.add('recording');
}

render();

// ═══════════════════════════════════════════════════════════
// PWA - Service Worker Registration & Update Management
// ═══════════════════════════════════════════════════════════
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(registration => {
      console.log('[PWA] Service Worker enregistré');
      
      // Vérifier les mises à jour toutes les 30 minutes
      setInterval(() => {
        registration.update();
        console.log('[PWA] Vérification mise à jour...');
      }, 30 * 60 * 1000);
      
      // Détecter une nouvelle version disponible
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'activated') {
            // Afficher notification de mise à jour
            if (confirm('🔄 Nouvelle version de VLEP Mission disponible !\n\nVoulez-vous recharger pour mettre à jour ?')) {
              window.location.reload();
            }
          }
        });
      });
    }).catch(err => {
      console.log('[PWA] Erreur SW:', err);
    });
  });
}
  </script>
</body>
</html>
